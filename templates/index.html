<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŸºé‡‘å¤§å¸ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.4;
            font-size: 13px;  /* åŸºç¡€å­—å·ç¼©å°1å· */
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.8rem 1.2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-left h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .navbar-left p {
            opacity: 0.9;
            margin-top: 0.2rem;
            font-size: 0.75rem;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .navbar-right a {
            color: white;
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .navbar-right a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* ç­›é€‰åŒºåŸŸ */
        .filter-section {
            background: var(--card-bg);
            border-radius: 6px;
            padding: 1rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .filter-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.8rem;
            margin-bottom: 0.8rem;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .filter-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-select, .filter-input {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.2s;
            background: white;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 0.8rem;
            justify-content: flex-end;
        }

        .btn {
            padding: 0.5rem 1.2rem;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* åŸºé‡‘åˆ—è¡¨ */
        .fund-list-section {
            background: var(--card-bg);
            border-radius: 6px;
            padding: 1rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            display: none;
        }

        .fund-list-section.show {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .section-title {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .fund-count {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 0.2rem;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        th, td {
            padding: 0.5rem 0.4rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-color);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            user-select: none;
            position: relative;
            white-space: nowrap;
        }

        th:hover {
            background: #e2e8f0;
        }

        th.sortable::after {
            content: ' â‡…';
            opacity: 0.3;
        }

        th.sort-asc::after {
            content: ' â†‘';
            opacity: 1;
        }

        th.sort-desc::after {
            content: ' â†“';
            opacity: 1;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: var(--bg-color);
        }

        .fund-code {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.75rem;
        }

        .fund-name {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.8rem;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #1d4ed8;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-cell {
            color: var(--text-secondary);
        }

        /* åˆ†é¡µ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.8rem;
        }

        .page-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-info {
            color: var(--text-secondary);
        }

        /* åŸºé‡‘è¯¦æƒ… */
        .detail-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: none;
        }

        .detail-section.show {
            display: block;
        }

        .back-btn {
            margin-bottom: 0.8rem;
        }

        .detail-header {
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .detail-title h2 {
            font-size: 1.3rem;
            margin-bottom: 0.4rem;
        }

        .detail-subtitle {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .info-table {
            width: 100%;
            margin-bottom: 0;
            font-size: 0.75rem;
        }

        .info-table th {
            text-align: right;
            padding: 0.4rem 0.8rem 0.4rem 0;
            width: 100px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
            background: none;
        }

        .info-table td {
            font-size: 0.75rem;
            padding: 0.4rem 0.5rem;
        }

        .section-divider {
            margin: 2rem 0 1rem 0;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0;
        }

        .data-card {
            padding: 0.6rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
        }

        .data-card.success {
            background: #f0fdf4;
            border-left: 3px solid var(--success-color);
        }

        .data-card.danger {
            background: #fef2f2;
            border-left: 3px solid var(--danger-color);
        }

        .data-card.warning {
            background: #fffbeb;
            border-left: 3px solid var(--warning-color);
        }

        .data-card.default {
            background: #f0f9ff;
            border-left: 3px solid var(--primary-color);
        }

        .data-label {
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-bottom: 0.2rem;
        }

        .data-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.8rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æµ®åŠ¨è¿”å›é¦–é¡µæŒ‰é’® */
        .float-back-btn {
            position: fixed;
            right: 30px;
            bottom: 30px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .float-back-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .float-back-btn.show {
            display: flex;
        }
        
        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.8rem;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                font-size: 0.7rem;
            }

            th, td {
                padding: 0.4rem 0.3rem;
            }
            
            .float-back-btn {
                right: 20px;
                bottom: 20px;
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }
        }

        /* é¡µè„šæ ·å¼ */
        .footer {
            background: var(--card-bg);
            border-top: 2px solid var(--border-color);
            padding: 2rem 1rem;
            margin-top: 3rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: #92400e;
            line-height: 1.6;
        }

        .footer-warning h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #dc2626;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .footer-links a:hover {
            color: #1e40af;
            text-decoration: underline;
        }

        .footer-copyright {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">
            <h1>AI åŸºé‡‘å¤§å¸ˆ v4.0 - æ™ºèƒ½åŸºé‡‘åˆ†æç³»ç»Ÿ</h1>
            <p>ä¸ºæ™®é€šæŠ•èµ„è€…æä¾›ä¸“ä¸šçš„åŸºé‡‘åˆ†ææœåŠ¡</p>
        </div>
        <div class="navbar-right">
            <span>ä½œè€…ï¼š</span>
            <a href="mailto:267278466@qq.com">267278466@qq.com</a>
        </div>
    </nav>

    <div class="container">
        <!-- ç­›é€‰åŒºåŸŸ -->
        <div class="filter-section">
            <h3 class="filter-title">ğŸ” åŸºé‡‘ç­›é€‰</h3>
            
            <div class="filter-grid">
                <div class="filter-item">
                    <label class="filter-label">åŸºé‡‘ä»£ç /åç§°</label>
                    <input type="text" class="filter-input" id="fundSearch" placeholder="è¾“å…¥ä»£ç æˆ–åç§°">
                </div>

                <div class="filter-item">
                    <label class="filter-label">åŸºé‡‘å…¬å¸</label>
                    <select class="filter-select" id="fundCompany">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label">åŸºé‡‘ç±»å‹</label>
                    <select class="filter-select" id="fundType">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label">æŠ•èµ„ç±»å‹</label>
                    <select class="filter-select" id="investType">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label">é£é™©ç­‰çº§</label>
                    <select class="filter-select" id="riskLevel">
                        <option value="">å…¨éƒ¨</option>
                        <option value="low">ä½é£é™©</option>
                        <option value="medium">ä¸­é£é™©</option>
                        <option value="high">é«˜é£é™©</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label">åŸºé‡‘çŠ¶æ€</label>
                    <select class="filter-select" id="fundStatus">
                        <option value="L">åœ¨å”®</option>
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
            </div>

            <div class="filter-buttons">
                <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
                <button class="btn btn-primary" onclick="applyFilters()">ç­›é€‰åŸºé‡‘</button>
            </div>
        </div>

        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>åŠ è½½ä¸­...</p>
        </div>

        <!-- åŸºé‡‘åˆ—è¡¨ -->
        <div class="fund-list-section" id="fundListSection">
            <div class="section-header">
                <div>
                    <h3 class="section-title">ğŸ“‹ åŸºé‡‘åˆ—è¡¨</h3>
                    <p class="fund-count" id="fundCount">å…± 0 åªåŸºé‡‘</p>
                </div>
                <div style="display: flex; gap: 0.8rem; align-items: center;">
                    <button class="btn btn-primary" id="calculateBtn" onclick="calculateAllReturnsBatch()">
                        è®¡ç®—æ‰€æœ‰æ”¶ç›Š
                    </button>
                    <span id="cacheStatus" style="font-size: 0.85rem; color: var(--text-secondary);"></span>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th class="sortable" data-sort="ts_code">ä»£ç </th>
                            <th class="sortable" data-sort="name">åç§°</th>
                            <th class="sortable" data-sort="fund_type">ç±»å‹</th>
                            <th class="sortable" data-sort="management">å…¬å¸</th>
                            <th class="sortable" data-sort="found_date">æˆç«‹æ—¥æœŸ</th>
                            <th class="sortable" data-sort="return2025">2025å¹´</th>
                            <th class="sortable" data-sort="return2024">2024å¹´</th>
                            <th class="sortable" data-sort="return2023">2023å¹´</th>
                            <th class="sortable" data-sort="score">è¯„åˆ†</th>
                            <th class="sortable" data-sort="rating">è¯„çº§</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="fundListBody">
                        <tr>
                            <td colspan="12" style="text-align: center; padding: 1.5rem; color: var(--text-secondary);">
                                
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination" id="pagination"></div>
        </div>

        <!-- æµ®åŠ¨è¿”å›é¦–é¡µæŒ‰é’® -->
        <button class="float-back-btn" id="floatBackBtn" onclick="backToHome()" title="è¿”å›é¦–é¡µ">
            ğŸ 
        </button>

        <!-- åŸºé‡‘è¯¦æƒ… -->
        <div class="detail-section" id="detailSection">
            <button class="btn btn-secondary back-btn" onclick="hideDetail()">â† è¿”å›åˆ—è¡¨</button>
            
            <div class="detail-header">
                <div class="detail-title">
                    <h2 id="fundName">åŸºé‡‘åç§°</h2>
                    <p class="detail-subtitle">
                        <span id="detailFundCode">åŸºé‡‘ä»£ç </span> | 
                        <span id="detailFundType">åŸºé‡‘ç±»å‹</span> | 
                        <span id="detailFundCompany">ç®¡ç†å…¬å¸</span>
                    </p>
                </div>
            </div>

            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div style="background: white; padding: 0.8rem; border-radius: 4px; border: 1px solid var(--border-color); margin-bottom: 0.8rem;">
                <h3 style="margin: 0 0 0.6rem 0; font-size: 0.9rem; color: var(--text-primary); font-weight: 600;">
                    ğŸ“‹ åŸºæœ¬ä¿¡æ¯
                </h3>
                <table class="info-table">
                    <tr>
                        <th>åŸºé‡‘ä»£ç ï¼š</th>
                        <td id="infoCode">--</td>
                        <th>åŸºé‡‘åç§°ï¼š</th>
                        <td id="infoName">--</td>
                    </tr>
                    <tr>
                        <th>åŸºé‡‘ç±»å‹ï¼š</th>
                        <td id="infoType">--</td>
                        <th>ç®¡ç†å…¬å¸ï¼š</th>
                        <td id="infoCompany">--</td>
                    </tr>
                    <tr>
                        <th>æˆç«‹æ—¥æœŸï¼š</th>
                        <td id="infoFoundDate">--</td>
                        <th>ä¸Šå¸‚æ—¥æœŸï¼š</th>
                        <td id="infoListDate">--</td>
                    </tr>
                    <tr>
                        <th>åŸºé‡‘çŠ¶æ€ï¼š</th>
                        <td id="infoStatus">--</td>
                        <th>åŸºé‡‘è§„æ¨¡ï¼š</th>
                        <td id="infoScale">--</td>
                    </tr>
                </table>
            </div>

            <!-- æŠ•èµ„å»ºè®® -->
            <div style="background: white; padding: 0.8rem; border-radius: 4px; border: 1px solid var(--border-color); border-left: 3px solid var(--primary-color); margin-bottom: 0.8rem;">
                <h3 style="margin: 0 0 0.6rem 0; font-size: 0.9rem; color: var(--text-primary); font-weight: 600;">ğŸ¯ æŠ•èµ„å»ºè®®</h3>
                <div id="investmentAdvice">
                    <p style="color: var(--text-secondary); font-size: 0.75rem;">æ­£åœ¨åˆ†æ...</p>
                </div>
            </div>

            <!-- æ”¶ç›Šå¯¹æ¯”åˆ†æ -->
            <div style="background: white; padding: 0.8rem; border-radius: 4px; border: 1px solid var(--border-color); margin-bottom: 0.8rem;">
                <h3 style="margin: 0 0 0.6rem 0; font-size: 0.9rem; color: var(--text-primary); font-weight: 600;">ğŸ“Š æ”¶ç›Šå¯¹æ¯”åˆ†æ</h3>
                
                <!-- å›¾è¡¨åŒºåŸŸ -->
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">ğŸ“ˆ å†å¹´æ”¶ç›Šç‡èµ°åŠ¿</div>
                        <div class="chart-wrapper">
                            <canvas id="returnsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">ğŸ’° å¹´æœ«å‡€å€¼èµ°åŠ¿</div>
                        <div class="chart-wrapper">
                            <canvas id="navChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- æ–‡å­—åˆ†æ -->
                <div id="returnComparison" style="font-size: 0.75rem;">
                    <p style="color: var(--text-secondary);">åŠ è½½ä¸­...</p>
                </div>
            </div>

            <!-- å‰åå¤§é‡ä»“è‚¡ -->
            <div style="background: white; padding: 0.8rem; border-radius: 4px; border: 1px solid var(--border-color); margin-bottom: 0.8rem;">
                <h3 style="margin: 0 0 0.6rem 0; font-size: 0.9rem; color: var(--text-primary); font-weight: 600;">ğŸ’¼ å‰åå¤§é‡ä»“è‚¡</h3>
                <div id="holdingsTable">
                    <p style="color: var(--text-secondary); font-size: 0.75rem;">åŠ è½½ä¸­...</p>
                </div>
            </div>

            <!-- æŒä»“é›†ä¸­åº¦ -->
            <div style="background: white; padding: 0.8rem; border-radius: 4px; border: 1px solid var(--border-color); margin-bottom: 0.8rem;">
                <h3 style="margin: 0 0 0.6rem 0; font-size: 0.9rem; color: var(--text-primary); font-weight: 600;">ğŸ“ˆ æŒä»“é›†ä¸­åº¦</h3>
                <div id="holdingInfo" style="font-size: 0.75rem;">--</div>
            </div>

            <!-- é£é™©æŒ‡æ ‡ -->
            <div style="background: white; padding: 0.8rem; border-radius: 4px; border: 1px solid var(--border-color); margin-bottom: 0.8rem;">
                <h3 style="margin: 0 0 0.6rem 0; font-size: 0.9rem; color: var(--text-primary); font-weight: 600;">âš ï¸ é£é™©æŒ‡æ ‡</h3>
                <table class="info-table" id="riskGrid"></table>
            </div>

            <!-- ç»¼åˆè¯„åˆ† -->
            <div style="background: white; padding: 0.8rem; border-radius: 4px; border: 1px solid var(--border-color); margin-bottom: 0.8rem;">
                <h3 style="margin: 0 0 0.6rem 0; font-size: 0.9rem; color: var(--text-primary); font-weight: 600;">â­ ç»¼åˆè¯„åˆ†</h3>
                <table class="info-table" id="scoreGrid"></table>
            </div>
        </div>
    </div>

    <script>
        let currentFunds = [];
        let allFunds = [];  // å­˜å‚¨æ‰€æœ‰åŸºé‡‘æ•°æ®
        let currentPage = 1;
        window.__currentFundReport = null;  // å…¨å±€ç¼“å­˜å½“å‰åŸºé‡‘æŠ¥å‘Šï¼ˆæŒ‚è½½åˆ° windowï¼Œé¿å…ä½œç”¨åŸŸé—®é¢˜ï¼‰
        const pageSize = 50;
        let sortColumn = null;
        let sortDirection = 'asc';
        
        // å…¨å±€é…ç½®ï¼šæ˜¯å¦åŒ…å«ETFåŸºé‡‘ï¼ˆé»˜è®¤ä¸åŒ…å«ï¼‰
        // å…¨å±€é…ç½®ï¼šè¿‡æ»¤è§„åˆ™
        const INCLUDE_ETF = false;  // æ˜¯å¦åŒ…å«ETFåŸºé‡‘
        const INCLUDE_FOF = false;  // æ˜¯å¦åŒ…å«FOFåŸºé‡‘
        const INCLUDE_LOF = false;  // æ˜¯å¦åŒ…å«LOFåŸºé‡‘
        
        // å½“å‰å¹´ä»½
        const currentYear = 2025;
        
        // ğŸ”¥ å…¨å±€å˜é‡ï¼šæ˜¯å¦ä½¿ç”¨ç¼“å­˜æ•°æ®
        let USE_CACHE = true;  // é»˜è®¤ä½¿ç”¨ç¼“å­˜
        let CACHE_STATUS = null;  // ç¼“å­˜çŠ¶æ€ä¿¡æ¯
        let AVAILABLE_YEARS = ['2025', '2024', '2023'];  // å¯ç”¨å¹´ä»½

        // æ˜¾ç¤ºæ°”æ³¡é€šçŸ¥ï¼ˆæ›¿ä»£alertï¼‰
        async function showNotification(message, title = 'åŸºé‡‘åˆ†æç³»ç»Ÿ') {
            try {
                await fetch('/api/notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, message })
                });
            } catch (error) {
                // å¦‚æœé€šçŸ¥å¤±è´¥ï¼Œé™çº§åˆ°console
                console.error('é€šçŸ¥å¤±è´¥:', message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            // ğŸ”¥ æ£€æŸ¥ç¼“å­˜çŠ¶æ€
            await checkCacheStatus();
            
            await loadFilterOptions();
            initSortHandlers();
            // è‡ªåŠ¨åŠ è½½æ‰€æœ‰åŸºé‡‘ï¼ˆé»˜è®¤çŠ¶æ€ä¸º"åœ¨å”®"ï¼‰
            await applyFilters();
        });
        
        // ğŸ”¥ æ£€æŸ¥é¢„è®¡ç®—ç¼“å­˜çŠ¶æ€
        async function checkCacheStatus() {
            try {
                const response = await fetch('/api/check_cache_status');
                const data = await response.json();
                
                if (data.success && data.data.has_cache) {
                    CACHE_STATUS = data.data;
                    USE_CACHE = true;
                    AVAILABLE_YEARS = data.data.available_years || ['2025', '2024', '2023'];
                    
                    console.log('âœ“ å‘ç°é¢„è®¡ç®—ç¼“å­˜:', CACHE_STATUS.message);
                    console.log('  å¯ç”¨å¹´ä»½:', AVAILABLE_YEARS.join(', '));
                    console.log('  åŸºé‡‘æ•°é‡:', CACHE_STATUS.fund_count);
                    console.log('  æ€»è®°å½•æ•°:', CACHE_STATUS.record_count);
                    
                    // ğŸ”¥ æ˜¾ç¤ºç¼“å­˜çŠ¶æ€æç¤º
                    const statusSpan = document.getElementById('cacheStatus');
                    if (statusSpan) {
                        statusSpan.innerHTML = `ğŸ“¦ å·²åŠ è½½ç¼“å­˜æ•°æ® (${CACHE_STATUS.fund_count}åªåŸºé‡‘)`;
                        statusSpan.style.color = '#16a34a';
                    }
                } else {
                    USE_CACHE = false;
                    AVAILABLE_YEARS = ['2025', '2024', '2023'];
                    console.log('âš  æ— é¢„è®¡ç®—ç¼“å­˜ï¼Œå°†ä½¿ç”¨å®æ—¶è®¡ç®—');
                    console.log('  æç¤ºï¼šè¿è¡Œ python precompute_returns.py ç”Ÿæˆç¼“å­˜');
                    
                    // ğŸ”¥ æ˜¾ç¤ºæ— ç¼“å­˜çŠ¶æ€æç¤º
                    const statusSpan = document.getElementById('cacheStatus');
                    if (statusSpan) {
                        statusSpan.innerHTML = `âš ï¸ æ— ç¼“å­˜æ•°æ®ï¼Œé¦–æ¬¡è®¡ç®—è¾ƒæ…¢`;
                        statusSpan.style.color = '#f59e0b';
                    }
                }
            } catch (error) {
                USE_CACHE = false;
                console.error('æ£€æŸ¥ç¼“å­˜å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–æ’åºå¤„ç†
        function initSortHandlers() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    sortTable(column);
                });
            });
        }

        // æ’åºè¡¨æ ¼
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // æ›´æ–°è¡¨å¤´æ ·å¼
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const currentTh = document.querySelector(`th[data-sort="${column}"]`);
            currentTh.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

            // æ’åºæ•°æ®
            allFunds.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // å¤„ç†æ•°å€¼ç±»å‹
                if (column.startsWith('return') || column === 'score') {
                    valA = parseFloat(valA) || -Infinity;
                    valB = parseFloat(valB) || -Infinity;
                }
                
                // ğŸ”¥ å¤„ç†è¯„çº§æ’åºï¼ˆè½¬æ¢ä¸ºæ•°å­—ï¼‰
                if (column === 'rating') {
                    const ratingToNumber = (rating) => {
                        if (!rating) return -1;
                        const str = String(rating);
                        if (str.includes('äº”æ˜Ÿ')) return 5;
                        if (str.includes('å››æ˜Ÿ')) return 4;
                        if (str.includes('ä¸‰æ˜Ÿ')) return 3;
                        if (str.includes('äºŒæ˜Ÿ')) return 2;
                        if (str.includes('ä¸€æ˜Ÿ')) return 1;
                        return 0;
                    };
                    valA = ratingToNumber(valA);
                    valB = ratingToNumber(valB);
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // é‡æ–°æ˜¾ç¤ºå½“å‰é¡µ
            displayPage(currentPage);
        }

        // åŠ è½½ç­›é€‰é€‰é¡¹
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter_options');
                const data = await response.json();

                if (data.success) {
                    const companySelect = document.getElementById('fundCompany');
                    data.data.companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company;
                        option.textContent = company;
                        companySelect.appendChild(option);
                    });

                    const typeSelect = document.getElementById('fundType');
                    data.data.fund_types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        typeSelect.appendChild(option);
                    });

                    const investSelect = document.getElementById('investType');
                    data.data.invest_types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        investSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
            }
        }

        // åº”ç”¨ç­›é€‰
        async function applyFilters() {
            const filters = {
                search: document.getElementById('fundSearch').value.trim(),
                company: document.getElementById('fundCompany').value,
                fund_type: document.getElementById('fundType').value,
                invest_type: document.getElementById('investType').value,
                risk_level: document.getElementById('riskLevel').value,
                status: document.getElementById('fundStatus').value
            };

            showLoading(true);
            hideFundList();
            hideDetail();

            try {
                const params = new URLSearchParams(filters);
                const response = await fetch(`/api/filter_funds?${params}`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    // è¿‡æ»¤ETFã€FOFã€LOFåŸºé‡‘ï¼ˆå¦‚æœé…ç½®ä¸ºä¸åŒ…å«ï¼‰
                    let funds = data.data;
                    const beforeCount = funds.length;
                    let filteredCount = { ETF: 0, FOF: 0, LOF: 0 };
                    
                    if (!INCLUDE_ETF) {
                        const before = funds.length;
                        funds = funds.filter(fund => !fund.name.includes('ETF'));
                        filteredCount.ETF = before - funds.length;
                    }
                    
                    if (!INCLUDE_FOF) {
                        const before = funds.length;
                        funds = funds.filter(fund => !fund.name.includes('FOF'));
                        filteredCount.FOF = before - funds.length;
                    }
                    
                    if (!INCLUDE_LOF) {
                        const before = funds.length;
                        funds = funds.filter(fund => !fund.name.includes('LOF'));
                        filteredCount.LOF = before - funds.length;
                    }
                    
                    // è¾“å‡ºè¿‡æ»¤æ—¥å¿—
                    const totalFiltered = filteredCount.ETF + filteredCount.FOF + filteredCount.LOF;
                    if (totalFiltered > 0) {
                        let logMsg = `å·²è¿‡æ»¤ ${totalFiltered} åªåŸºé‡‘ï¼š`;
                        if (filteredCount.ETF > 0) logMsg += ` ETF(${filteredCount.ETF})`;
                        if (filteredCount.FOF > 0) logMsg += ` FOF(${filteredCount.FOF})`;
                        if (filteredCount.LOF > 0) logMsg += ` LOF(${filteredCount.LOF})`;
                        console.log(logMsg);
                    }
                    
                    if (funds.length === 0) {
                        showNotification('è¿‡æ»¤åæœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åŸºé‡‘', 'ç­›é€‰ç»“æœ');
                        return;
                    }
                    
                    allFunds = funds.map(fund => ({
                        ...fund,
                        return2025: null,
                        return2024: null,
                        return2023: null,
                        score: null,
                        rating: null,
                        starCount: 0,
                        isRedStar: false
                    }));
                    currentPage = 1;
                    
                    // ğŸ”¥ ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åå†æ˜¾ç¤º
                    if (USE_CACHE && CACHE_STATUS) {
                        console.log('ğŸš€ ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®...');
                        const statusSpan = document.getElementById('cacheStatus');
                        if (statusSpan) {
                            statusSpan.innerHTML = `ğŸ“Š æ­£åœ¨è¯»å–æ•°æ®...`;
                            statusSpan.style.color = 'var(--primary-color)';
                        }
                        
                        loadAllDataAtOnce()
                            .then(() => {
                                console.log('âœ“ æ•°æ®åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºåˆ—è¡¨');
                                displayPage(1);
                                showFundList();
                                
                                if (statusSpan) {
                                    statusSpan.innerHTML = `âœ… åŠ è½½å®Œæˆ`;
                                    statusSpan.style.color = '#16a34a';
                                }
                            })
                            .catch(error => {
                                console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', error);
                                // å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤ºåˆ—è¡¨
                                displayPage(1);
                                showFundList();
                                
                                const statusSpan = document.getElementById('cacheStatus');
                                if (statusSpan) {
                                    statusSpan.innerHTML = `âš ï¸ åŠ è½½å¤±è´¥`;
                                    statusSpan.style.color = '#dc2626';
                                }
                            });
                    } else {
                        // æ²¡æœ‰ç¼“å­˜ï¼Œç›´æ¥æ˜¾ç¤º
                        displayPage(1);
                        showFundList();
                    }
                } else {
                    showNotification('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åŸºé‡‘', 'ç­›é€‰ç»“æœ');
                }
            } catch (error) {
                showNotification('ç­›é€‰å¤±è´¥ï¼š' + error.message, 'é”™è¯¯');
            } finally {
                showLoading(false);
            }
        }

        // ğŸ”¥ ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆè¯„åˆ†+æ”¶ç›Šï¼‰
        async function loadAllDataAtOnce() {
            const startTime = performance.now();
            console.log('ğŸ“Š ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰æ•°æ®...');
            
            try {
                const tsCodes = allFunds.map(f => f.ts_code);
                console.log(`  å…± ${tsCodes.length} åªåŸºé‡‘`);
                
                // ğŸ”¥ è¯„åˆ†å’Œæ”¶ç›Šä¸€èµ·ä» batch_year_returns è·å–
                console.log('  â†’ è¯·æ±‚æ”¶ç›Šå’Œè¯„åˆ†æ•°æ®ï¼ˆåˆå¹¶ï¼‰...');
                const returnsPromise = fetch('/api/batch_year_returns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ts_codes: tsCodes,
                        years: AVAILABLE_YEARS,
                        use_cache: USE_CACHE
                    })
                }).then(res => {
                    console.log(`  â† å“åº”: ${res.status}`);
                    if (!res.ok) throw new Error(`APIè¿”å›${res.status}`);
                    return res.json();
                }).catch(err => {
                    console.error('  âœ— è¯·æ±‚å¤±è´¥:', err);
                    return { success: false, data: {} };
                });
                
                const returnsData = await returnsPromise;
                console.log(`  âœ“ æ•°æ®è·å–${returnsData.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                
                // ğŸ”¥ ä»æ”¶ç›Šæ•°æ®ä¸­æå–è¯„åˆ†å’Œæ”¶ç›Šç‡
                allFunds.forEach(fund => {
                    if (returnsData.success && returnsData.data[fund.ts_code]) {
                        const fundData = returnsData.data[fund.ts_code];
                        
                        // 1. è®¾ç½®è¯„åˆ†ï¼ˆä»è¿”å›æ•°æ®ä¸­è·å–ï¼Œå¦‚æœæœ‰çš„è¯ï¼‰
                        fund.score = fundData.score || null;
                        
                        // 2. è®¾ç½®æ”¶ç›Šç‡
                        fund.return2025 = fundData['2025'];
                        fund.return2024 = fundData['2024'];
                        fund.return2023 = fundData['2023'];
                    }
                    
                    // 3. æ ¹æ®è¯„åˆ†è®¡ç®—æ˜Ÿçº§
                    if (fund.score !== null && fund.score !== undefined) {
                        const score = parseFloat(fund.score);
                        if (score > 80) {
                            fund.rating = 'äº”æ˜Ÿ â˜…â˜…â˜…â˜…â˜…';
                            fund.starCount = 5;
                        } else if (score > 70) {
                            fund.rating = 'å››æ˜Ÿ â˜…â˜…â˜…â˜…';
                            fund.starCount = 4;
                        } else if (score > 60) {
                            fund.rating = 'ä¸‰æ˜Ÿ â˜…â˜…â˜…';
                            fund.starCount = 3;
                        } else if (score > 50) {
                            fund.rating = 'äºŒæ˜Ÿ â˜…â˜…';
                            fund.starCount = 2;
                        } else {
                            fund.rating = 'ä¸€æ˜Ÿ â˜…';
                            fund.starCount = 1;
                        }
                    } else {
                        fund.rating = null;
                        fund.starCount = 0;
                    }
                    
                    fund.isRedStar = false;
                });
                
                // æ£€æŸ¥çº¢æ˜Ÿè¯„çº§
                const redStarCandidates = allFunds
                    .filter(f => f.starCount >= 4)
                    .map(f => ({ ts_code: f.ts_code, rating: f.starCount }));
                
                if (redStarCandidates.length > 0) {
                    try {
                        const redStarData = await fetch('/api/check_gold_rating', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ funds: redStarCandidates })
                        }).then(res => res.json());
                        
                        if (redStarData.success) {
                            let redCount = 0;
                            allFunds.forEach(fund => {
                                if (redStarData.data[fund.ts_code]) {
                                    fund.isRedStar = true;
                                    redCount++;
                                }
                            });
                            console.log(`  âœ“ å‘ç° ${redCount} åªçº¢æ˜ŸåŸºé‡‘`);
                        }
                    } catch (error) {
                        console.warn('âš ï¸ çº¢æ˜Ÿè¯„çº§æ£€æŸ¥å¤±è´¥:', error.message);
                    }
                }
                
                // æ’åºï¼šå…ˆæŒ‰æ˜Ÿçº§é™åºï¼Œå†æŒ‰çº¢æ˜Ÿè¯„çº§
                allFunds.sort((a, b) => {
                    const starDiff = (b.starCount || 0) - (a.starCount || 0);
                    if (starDiff !== 0) return starDiff;
                    
                    const redA = a.isRedStar ? 1 : 0;
                    const redB = b.isRedStar ? 1 : 0;
                    return redB - redA;
                });
                
                const duration = ((performance.now() - startTime) / 1000).toFixed(2);
                console.log(`âœ“ å…¨éƒ¨æ•°æ®åŠ è½½å®Œæˆï¼è€—æ—¶: ${duration}ç§’`);
                
            } catch (error) {
                console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', error);
                throw error;
            }
        }
        
        // ğŸ”¥ å¿«é€ŸåŠ è½½è¯„åˆ†å’Œæ˜Ÿçº§ï¼Œç„¶åæ’åº
        async function loadScoresAndSort() {
            const startTime = performance.now();
            console.log('ğŸ“Š å¼€å§‹å¿«é€Ÿè¯»å–è¯„åˆ†...');
            
            try {
                const tsCodes = allFunds.map(f => f.ts_code);
                const batchSize = 400;
                const totalBatches = Math.ceil(tsCodes.length / batchSize);
                console.log(`  è¯·æ±‚è¯„åˆ†æ•°æ®: ${tsCodes.length} åªåŸºé‡‘ï¼Œåˆ† ${totalBatches} æ‰¹å¤„ç†`);
                
                const mergedScores = {};
                const redStarCandidates = [];
                
                for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                    const start = batchIndex * batchSize;
                    const end = Math.min(start + batchSize, tsCodes.length);
                    const batchCodes = tsCodes.slice(start, end);
                    const batchFunds = allFunds.slice(start, end);
                    
                    console.log(`  â¤ ç¬¬ ${batchIndex + 1}/${totalBatches} æ‰¹ï¼š${batchCodes.length} åªåŸºé‡‘`);
                    
                    const response = await fetch('/api/batch_scores', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ts_codes: batchCodes })
                    }).catch(error => {
                        console.error(`  âœ— ç¬¬ ${batchIndex + 1} æ‰¹è¯·æ±‚å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰`, error);
                        throw error;
                    });
                    
                    console.log(`    â†³ å“åº”çŠ¶æ€: ${response.status}`);
                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(`ç¬¬ ${batchIndex + 1} æ‰¹è¯·æ±‚å¤±è´¥ï¼ŒHTTP ${response.status}: ${response.statusText} - ${text}`);
                    }
                    
                    const scoresData = await response.json();
                    if (!scoresData.success) {
                        throw new Error(`ç¬¬ ${batchIndex + 1} æ‰¹è¿”å›å¤±è´¥: ${JSON.stringify(scoresData)}`);
                    }
                    
                    Object.assign(mergedScores, scoresData.data);
                    
                    batchFunds.forEach(fund => {
                        fund.score = scoresData.data[fund.ts_code];
                        
                        if (fund.score !== null && fund.score !== undefined) {
                            const score = parseFloat(fund.score);
                            if (score > 80) {
                                fund.rating = 'äº”æ˜Ÿ â˜…â˜…â˜…â˜…â˜…';
                                fund.starCount = 5;
                            } else if (score > 70) {
                                fund.rating = 'å››æ˜Ÿ â˜…â˜…â˜…â˜…';
                                fund.starCount = 4;
                            } else if (score > 60) {
                                fund.rating = 'ä¸‰æ˜Ÿ â˜…â˜…â˜…';
                                fund.starCount = 3;
                            } else if (score > 50) {
                                fund.rating = 'äºŒæ˜Ÿ â˜…â˜…';
                                fund.starCount = 2;
                            } else {
                                fund.rating = 'ä¸€æ˜Ÿ â˜…';
                                fund.starCount = 1;
                            }
                        } else {
                            fund.rating = null;
                            fund.starCount = 0;
                        }
                        
                        fund.isRedStar = false;
                        if (fund.starCount >= 4) {
                            redStarCandidates.push({ ts_code: fund.ts_code, rating: fund.starCount });
                        }
                    });
                }
                
                const scoreCount = Object.keys(mergedScores).length;
                const validScores = Object.values(mergedScores).filter(s => s !== null && s !== undefined).length;
                console.log(`âœ“ è·å–è¯„åˆ†: ${scoreCount} åªåŸºé‡‘ï¼Œå…¶ä¸­ ${validScores} åªæœ‰æ•ˆè¯„åˆ†`);
                
                // æ£€æŸ¥çº¢æ˜Ÿè¯„çº§
                if (redStarCandidates.length > 0) {
                    console.log(`  è¯·æ±‚çº¢æ˜Ÿè¯„çº§: ${redStarCandidates.length} åªåŸºé‡‘`);
                    try {
                        const redStarData = await fetch('/api/check_gold_rating', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ funds: redStarCandidates })
                        }).then(res => res.json());
                        
                        if (redStarData.success) {
                            let redCount = 0;
                            allFunds.forEach(fund => {
                                if (redStarData.data[fund.ts_code]) {
                                    fund.isRedStar = true;
                                    redCount++;
                                }
                            });
                            console.log(`âœ“ å‘ç° ${redCount} åªçº¢æ˜ŸåŸºé‡‘`);
                        }
                    } catch (error) {
                        console.warn('âš ï¸ çº¢æ˜Ÿè¯„çº§æ£€æŸ¥å¤±è´¥', error);
                    }
                }
                
                // æ’åº
                allFunds.sort((a, b) => {
                    const starDiff = (b.starCount || 0) - (a.starCount || 0);
                    if (starDiff !== 0) return starDiff;
                    
                    const redA = a.isRedStar ? 1 : 0;
                    const redB = b.isRedStar ? 1 : 0;
                    return redB - redA;
                });
                
                const duration = ((performance.now() - startTime) / 1000).toFixed(2);
                console.log(`âœ“ è¯„åˆ†åŠ è½½å’Œæ’åºå®Œæˆï¼è€—æ—¶: ${duration}ç§’`);
                
                console.log('æ’åºåçš„å‰3ä¸ªåŸºé‡‘:');
                allFunds.slice(0, 3).forEach((f, i) => {
                    console.log(`  ${i+1}. ${f.ts_code} - è¯„åˆ†:${f.score} æ˜Ÿçº§:${f.starCount} çº¢æ˜Ÿ:${f.isRedStar}`);
                });
            } catch (error) {
                console.error('å¿«é€ŸåŠ è½½è¯„åˆ†å¤±è´¥:', error);
                throw error;
            }
        }
        
        // ğŸ”¥ åŠ è½½è¯¦ç»†æ”¶ç›Šæ•°æ®ï¼ˆåå°è¿›è¡Œï¼‰
        async function loadDetailedReturns() {
            const startTime = performance.now();
            console.log('ğŸ“¦ å¼€å§‹åŠ è½½è¯¦ç»†æ”¶ç›Šæ•°æ®...');
            
            try {
                const batchSize = 100;
                const totalBatches = Math.ceil(allFunds.length / batchSize);
                
                for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                    const start = batchIndex * batchSize;
                    const end = Math.min(start + batchSize, allFunds.length);
                    const batchFunds = allFunds.slice(start, end);
                    const tsCodes = batchFunds.map(f => f.ts_code);
                    
                    // æ‰¹é‡è·å–å¹´åº¦æ”¶ç›Š
                    const yearReturnsData = await fetch('/api/batch_year_returns', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ts_codes: tsCodes,
                            years: AVAILABLE_YEARS,
                            use_cache: USE_CACHE
                        })
                    }).then(res => res.json());
                    
                    if (yearReturnsData.success) {
                        batchFunds.forEach(fund => {
                            const returns = yearReturnsData.data[fund.ts_code];
                            if (returns) {
                                fund.return2025 = returns['2025'];
                                fund.return2024 = returns['2024'];
                                fund.return2023 = returns['2023'];
                            }
                        });
                        
                        // æ›´æ–°å½“å‰é¡µæ˜¾ç¤º
                        const pageStart = (currentPage - 1) * pageSize;
                        const pageEnd = pageStart + pageSize;
                        const currentPageFunds = batchFunds.filter((_, index) => {
                            const globalIndex = start + index;
                            return globalIndex >= pageStart && globalIndex < pageEnd;
                        });
                        
                        currentPageFunds.forEach(fund => updateFundRow(fund));
                    }
                    
                    // æ›´æ–°è¿›åº¦
                    const progress = Math.round((batchIndex + 1) / totalBatches * 100);
                    const statusSpan = document.getElementById('cacheStatus');
                    if (statusSpan) {
                        statusSpan.innerHTML = `ğŸ“¦ åŠ è½½ä¸­... ${progress}%`;
                    }
                }
                
                const duration = ((performance.now() - startTime) / 1000).toFixed(2);
                console.log(`âœ“ è¯¦ç»†æ•°æ®åŠ è½½å®Œæˆï¼è€—æ—¶: ${duration}ç§’`);
                
                const statusSpan = document.getElementById('cacheStatus');
                if (statusSpan) {
                    statusSpan.innerHTML = `âœ… å…¨éƒ¨åŠ è½½å®Œæˆ`;
                    statusSpan.style.color = '#16a34a';
                }
            } catch (error) {
                console.error('åŠ è½½è¯¦ç»†æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæŒ‡å®šé¡µ
        function displayPage(page) {
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            currentFunds = allFunds.slice(start, end);
            
            displayFundList(currentFunds, start);
            displayPagination(page, Math.ceil(allFunds.length / pageSize));
            
            // ä¸å†è‡ªåŠ¨è®¡ç®—æ”¶ç›Šï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»"è®¡ç®—æ‰€æœ‰æ”¶ç›Š"æŒ‰é’®
        }

        // æ˜¾ç¤ºåŸºé‡‘åˆ—è¡¨
        function displayFundList(funds, startIndex) {
            const tbody = document.getElementById('fundListBody');
            tbody.innerHTML = '';

            document.getElementById('fundCount').textContent = `å…± ${allFunds.length} åªåŸºé‡‘`;

            funds.forEach((fund, index) => {
                const globalIndex = startIndex + index + 1;
                const safeCode = fund.ts_code.replace(/\./g, '_');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${globalIndex}</td>
                    <td class="fund-code">${fund.ts_code}</td>
                    <td class="fund-name" title="${fund.name}">${fund.name}</td>
                    <td>${fund.fund_type || '--'}</td>
                    <td>${fund.management || '--'}</td>
                    <td>${fund.found_date || '--'}</td>
                    <td id="return2025_${safeCode}" class="loading-cell">${formatReturn(fund.return2025)}</td>
                    <td id="return2024_${safeCode}" class="loading-cell">${formatReturn(fund.return2024)}</td>
                    <td id="return2023_${safeCode}" class="loading-cell">${formatReturn(fund.return2023)}</td>
                    <td id="score_${safeCode}" class="loading-cell">${formatScore(fund.score)}</td>
                    <td id="rating_${safeCode}" class="loading-cell">${formatRating(fund.rating, fund.isRedStar)}</td>
                    <td>
                        <button class="action-btn" onclick="showFundDetail('${fund.ts_code}')">
                            è¯¦æƒ…
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ ¼å¼åŒ–æ”¶ç›Šç‡ï¼ˆçº¢æ¶¨ç»¿è·Œï¼‰- ä¿®å¤ï¼šæœªè®¡ç®—æ—¶ä¸æ˜¾ç¤º0%
        function formatReturn(value) {
            // ä¸¥æ ¼æ£€æŸ¥ï¼šåªæœ‰æ˜ç¡®çš„æœ‰æ•ˆæ•°å­—æ‰æ˜¾ç¤º
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            // å°è¯•è½¬æ¢ä¸ºæ•°å­—
            const numValue = parseFloat(value);
            
            // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œè¿”å› "--"
            if (isNaN(numValue)) {
                return '--';
            }
            
            // ç‰¹æ®Šå¤„ç†ï¼š0 ä¹Ÿéœ€è¦æ˜¾ç¤ºï¼ˆçœŸæ­£çš„0æ”¶ç›Šï¼‰
            // ä½†è¦åŒºåˆ†"æœªè®¡ç®—"å’Œ"æ”¶ç›Šä¸º0"
            // çº¢æ¶¨ç»¿è·Œé…è‰²
            let color, text;
            if (numValue > 0) {
                color = '#dc2626';  // çº¢è‰²
                text = `+${numValue}%`;
            } else if (numValue < 0) {
                color = '#16a34a';  // ç»¿è‰²
                text = `${numValue}%`;
            } else {
                // numValue === 0
                color = 'var(--text-secondary)';  // ç°è‰²ï¼ˆä¸­æ€§ï¼‰
                text = '0%';
            }
            
            return `<span style="color: ${color}; font-weight: 600;">${text}</span>`;
        }

        // æ ¼å¼åŒ–è¯„åˆ†
        function formatScore(value) {
            if (value === null || value === undefined || value === '' || isNaN(value)) {
                return '--';
            }
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return '--';
            
            let color = 'var(--text-secondary)';
            if (numValue >= 80) color = 'var(--success-color)';
            else if (numValue >= 70) color = 'var(--primary-color)';
            else if (numValue >= 60) color = 'var(--warning-color)';
            return `<span style="color: ${color}; font-weight: 600;">${numValue}/100</span>`;
        }
        
        // ğŸ”¥ æ ¼å¼åŒ–è¯„çº§ï¼ˆæ˜¾ç¤ºæ˜Ÿçº§ï¼‰
        function formatRating(value, isRedStar = false) {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            // è§£æè¯„çº§ï¼ˆå¦‚"äº”æ˜Ÿ â˜…â˜…â˜…â˜…â˜…"ï¼‰
            const ratingText = String(value);
            
            // ğŸ”¥ çº¢æ˜Ÿè¯„çº§ä¼˜å…ˆï¼ˆçº¢è‰²ï¼‰
            if (isRedStar) {
                if (ratingText.includes('äº”æ˜Ÿ')) {
                    return '<span style="color: #dc2626; font-weight: 600;">â˜…â˜…â˜…â˜…â˜…</span>';
                } else if (ratingText.includes('å››æ˜Ÿ')) {
                    return '<span style="color: #dc2626; font-weight: 600;">â˜…â˜…â˜…â˜…</span>';
                }
            }
            
            // ğŸ”¥ æ–°é¢œè‰²æ ‡å‡†
            // æ ¹æ®æ˜Ÿçº§è¿”å›é¢œè‰²å’Œå›¾æ ‡
            if (ratingText.includes('äº”æ˜Ÿ')) {
                // 5æ˜Ÿ - é»„è‰²
                return '<span style="color: #FFD700; font-weight: 600;">â˜…â˜…â˜…â˜…â˜…</span>';
            } else if (ratingText.includes('å››æ˜Ÿ')) {
                // 4æ˜Ÿ - è“è‰²
                return '<span style="color: #2563eb; font-weight: 600;">â˜…â˜…â˜…â˜…</span>';
            } else if (ratingText.includes('ä¸‰æ˜Ÿ')) {
                // 3æ˜Ÿ - è“è‰²
                return '<span style="color: #2563eb; font-weight: 600;">â˜…â˜…â˜…</span>';
            } else if (ratingText.includes('äºŒæ˜Ÿ')) {
                // 2æ˜Ÿ - ç»¿è‰²
                return '<span style="color: #16a34a; font-weight: 600;">â˜…â˜…</span>';
            } else if (ratingText.includes('ä¸€æ˜Ÿ')) {
                // 1æ˜Ÿ - ç»¿è‰²
                return '<span style="color: #16a34a; font-weight: 600;">â˜…</span>';
            }
            
            return '--';
        }

        // æ˜¾ç¤ºåˆ†é¡µ
        function displayPagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // ä¸Šä¸€é¡µ
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.textContent = 'ä¸Šä¸€é¡µ';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => changePage(currentPage - 1);
            pagination.appendChild(prevBtn);

            // é¡µç æŒ‰é’®
            const maxButtons = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            if (startPage > 1) {
                const btn1 = document.createElement('button');
                btn1.className = 'page-btn';
                btn1.textContent = '1';
                btn1.onclick = () => changePage(1);
                pagination.appendChild(btn1);

                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '0 0.5rem';
                    pagination.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = 'page-btn';
                if (i === currentPage) btn.classList.add('active');
                btn.textContent = i;
                btn.onclick = () => changePage(i);
                pagination.appendChild(btn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '0 0.5rem';
                    pagination.appendChild(dots);
                }

                const btnLast = document.createElement('button');
                btnLast.className = 'page-btn';
                btnLast.textContent = totalPages;
                btnLast.onclick = () => changePage(totalPages);
                pagination.appendChild(btnLast);
            }

            // ä¸‹ä¸€é¡µ
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => changePage(currentPage + 1);
            pagination.appendChild(nextBtn);

            // é¡µç ä¿¡æ¯
            const info = document.createElement('span');
            info.className = 'page-info';
            info.textContent = `ç¬¬ ${currentPage}/${totalPages} é¡µ`;
            pagination.appendChild(info);
        }

        // åˆ‡æ¢é¡µç 
        function changePage(page) {
            currentPage = page;
            displayPage(page);
        }

        // è®¡ç®—æ‰€æœ‰æ”¶ç›Š
        async function calculateAllReturns() {
            if (allFunds.length === 0) {
                showNotification('è¯·å…ˆç­›é€‰åŸºé‡‘', 'æç¤º');
                return;
            }

            const btn = document.getElementById('calculateBtn');
            btn.disabled = true;
            btn.textContent = 'è®¡ç®—ä¸­...';

            console.log(`å¼€å§‹è®¡ç®— ${allFunds.length} åªåŸºé‡‘çš„æ”¶ç›Š...`);

            for (let i = 0; i < allFunds.length; i++) {
                const fund = allFunds[i];

                try {
                    // å¹¶å‘è®¡ç®—å„æœŸæ”¶ç›Šï¼ˆæé«˜é€Ÿåº¦ï¼‰
                    const results = await Promise.all([
                        calculateYearReturn(fund.ts_code, '2025'),
                        calculateYearReturn(fund.ts_code, '2024'),
                        calculateYearReturn(fund.ts_code, '2023'),
                        calculateScore(fund.ts_code)
                    ]);

                    fund.return2025 = results[0];
                    fund.return2024 = results[1];
                    fund.return2023 = results[2];
                    fund.score = results[3];

                    console.log(`${fund.ts_code}: 2025=${results[0]}%, 2024=${results[1]}%, 2023=${results[2]}%`);

                    // å¦‚æœåœ¨å½“å‰é¡µï¼Œæ›´æ–°æ˜¾ç¤º
                    const pageStart = (currentPage - 1) * pageSize;
                    const pageEnd = pageStart + pageSize;
                    if (i >= pageStart && i < pageEnd) {
                        updateFundRow(fund);
                    }

                } catch (error) {
                    console.error(`è®¡ç®— ${fund.ts_code} å¤±è´¥:`, error);
                }

                // æ¯10ä¸ªåŸºé‡‘æ›´æ–°ä¸€æ¬¡æŒ‰é’®æ–‡æœ¬
                if ((i + 1) % 10 === 0 || i === allFunds.length - 1) {
                    btn.textContent = `è®¡ç®—ä¸­... (${i + 1}/${allFunds.length})`;
                }
            }

            btn.disabled = false;
            btn.textContent = 'é‡æ–°è®¡ç®—';
            console.log('æ”¶ç›Šè®¡ç®—å®Œæˆï¼');
        }

        // æ‰¹é‡è®¡ç®—æ‰€æœ‰æ”¶ç›Šï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        async function calculateAllReturnsBatch(isAutoLoad = false) {
            if (allFunds.length === 0) {
                showNotification('è¯·å…ˆç­›é€‰åŸºé‡‘', 'æç¤º');
                return;
            }

            const btn = document.getElementById('calculateBtn');
            const statusSpan = document.getElementById('cacheStatus');
            const isManualClick = !isAutoLoad;  // ğŸ”¥ é€šè¿‡å‚æ•°æ˜ç¡®åˆ¤æ–­æ˜¯å¦æ‰‹åŠ¨ç‚¹å‡»
            btn.disabled = true;
            
            // ğŸ”¥ ç‚¹å‡»è®¡ç®—æŒ‰é’®æ—¶ï¼Œåˆ‡æ¢åˆ°å®æ—¶è®¡ç®—
            if (isManualClick && USE_CACHE && btn.textContent.includes('è®¡ç®—æ‰€æœ‰æ”¶ç›Š')) {
                USE_CACHE = false;
                btn.textContent = 'âš¡ å®æ—¶è®¡ç®—ä¸­...';
                console.log('ğŸ”„ ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»ï¼Œåˆ‡æ¢åˆ°å®æ—¶è®¡ç®—æ¨¡å¼');
                if (statusSpan) {
                    statusSpan.innerHTML = `âš¡ å®æ—¶è®¡ç®—ä¸­... (è¾ƒæ…¢ï¼Œçº¦2-3åˆ†é’Ÿ)`;
                    statusSpan.style.color = '#f59e0b';
                }
            } else if (isManualClick) {
                btn.textContent = 'âš¡ å®æ—¶è®¡ç®—ä¸­...';
                if (statusSpan) {
                    statusSpan.innerHTML = `âš¡ å®æ—¶è®¡ç®—ä¸­... (è¾ƒæ…¢ï¼Œçº¦2-3åˆ†é’Ÿ)`;
                    statusSpan.style.color = '#f59e0b';
                }
            } else if (USE_CACHE) {
                // ğŸ”¥ è‡ªåŠ¨åŠ è½½ç¼“å­˜æ—¶ï¼Œä¸æ”¹å˜æŒ‰é’®çŠ¶æ€
                console.log('ğŸ“¦ è‡ªåŠ¨åŠ è½½é¢„è®¡ç®—ç¼“å­˜æ•°æ®...');
            }

            console.log(`${isManualClick ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨'}æ‰¹é‡è·å– ${allFunds.length} åªåŸºé‡‘çš„æ”¶ç›Š...`);
            console.log(`æ•°æ®æ¥æº: ${USE_CACHE ? 'ğŸ“¦ ç¼“å­˜ (å¿«é€Ÿ)' : 'âš¡ å®æ—¶è®¡ç®— (æ…¢é€Ÿ)'}`);
            const startTime = performance.now();

            try {
                // åˆ†æ‰¹å¤„ç†ï¼ˆæ¯æ‰¹100ä¸ªåŸºé‡‘ï¼‰
                const batchSize = 100;
                const totalBatches = Math.ceil(allFunds.length / batchSize);
                
                for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                    const start = batchIndex * batchSize;
                    const end = Math.min(start + batchSize, allFunds.length);
                    const batchFunds = allFunds.slice(start, end);
                    const tsCodes = batchFunds.map(f => f.ts_code);
                    
                    console.log(`å¤„ç†ç¬¬ ${batchIndex + 1}/${totalBatches} æ‰¹ (${tsCodes.length}åªåŸºé‡‘)...`);
                    
                    // ğŸ”¥ æ‰¹é‡è®¡ç®—å¹´åº¦æ”¶ç›Šï¼ˆä½¿ç”¨å…¨å±€å˜é‡æ§åˆ¶ç¼“å­˜ï¼‰
                    const yearReturnsData = await fetch('/api/batch_year_returns', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ts_codes: tsCodes,
                            years: AVAILABLE_YEARS,  // ä½¿ç”¨æ‰€æœ‰å¯ç”¨å¹´ä»½
                            use_cache: USE_CACHE     // ä½¿ç”¨å…¨å±€å˜é‡
                        })
                    }).then(res => res.json());
                    
                    // ğŸ”¥ æ‰¹é‡è®¡ç®—è¯„åˆ†ï¼ˆä¼˜åŒ–ï¼šå¤ç”¨å¹´åº¦æ”¶ç›Šæ•°æ®ï¼Œé¿å…é‡å¤æŸ¥è¯¢ï¼‰
                    const scoresData = await fetch('/api/batch_scores', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ts_codes: tsCodes,
                            year_returns: yearReturnsData.data  // ä¼ é€’å·²è·å–çš„æ”¶ç›Šæ•°æ®
                        })
                    }).then(res => res.json());
                    
                    // æ›´æ–°åŸºé‡‘æ•°æ®
                    if (yearReturnsData.success && scoresData.success) {
                        batchFunds.forEach((fund, index) => {
                            const returns = yearReturnsData.data[fund.ts_code];
                            if (returns) {
                                fund.return2025 = returns['2025'];
                                fund.return2024 = returns['2024'];
                                fund.return2023 = returns['2023'];
                            }
                            fund.score = scoresData.data[fund.ts_code];
                            
                            // ğŸ”¥ æ ¹æ®è¯„åˆ†è®¡ç®—è¯„çº§
                            if (fund.score !== null && fund.score !== undefined) {
                                const score = parseFloat(fund.score);
                                if (score > 80) {
                                    fund.rating = 'äº”æ˜Ÿ â˜…â˜…â˜…â˜…â˜…';
                                    fund.starCount = 5;
                                } else if (score > 70) {
                                    fund.rating = 'å››æ˜Ÿ â˜…â˜…â˜…â˜…';
                                    fund.starCount = 4;
                                } else if (score > 60) {
                                    fund.rating = 'ä¸‰æ˜Ÿ â˜…â˜…â˜…';
                                    fund.starCount = 3;
                                } else if (score > 50) {
                                    fund.rating = 'äºŒæ˜Ÿ â˜…â˜…';
                                    fund.starCount = 2;
                                } else {
                                    fund.rating = 'ä¸€æ˜Ÿ â˜…';
                                    fund.starCount = 1;
                                }
                            } else {
                                fund.rating = null;
                                fund.starCount = 0;
                            }
                            
                            // åˆå§‹åŒ–çº¢æ˜Ÿè¯„çº§æ ‡è®°
                            fund.isRedStar = false;
                        });
                        
                        // æ›´æ–°å½“å‰é¡µæ˜¾ç¤º
                        const pageStart = (currentPage - 1) * pageSize;
                        const pageEnd = pageStart + pageSize;
                        batchFunds.forEach((fund, index) => {
                            const globalIndex = start + index;
                            if (globalIndex >= pageStart && globalIndex < pageEnd) {
                                updateFundRow(fund);
                            }
                        });
                    }
                    
                    // æ›´æ–°è¿›åº¦ï¼ˆä»…æ‰‹åŠ¨ç‚¹å‡»æ—¶æ˜¾ç¤ºï¼‰
                    if (isManualClick) {
                        const progress = Math.round((end / allFunds.length) * 100);
                        btn.textContent = `è®¡ç®—ä¸­... ${progress}%`;
                    }
                }
                
                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                // ğŸ”¥ æ‰¹é‡æ£€æŸ¥æ‰€æœ‰ >= 4æ˜Ÿçš„åŸºé‡‘çš„é‡‘è‰²è¯„çº§
                const allGoldCandidates = allFunds
                    .filter(f => f.starCount >= 4)
                    .map(f => ({ ts_code: f.ts_code, rating: f.starCount }));
                
                if (allGoldCandidates.length > 0) {
                    try {
                        console.log(`æ£€æŸ¥çº¢æ˜Ÿè¯„çº§: ${allGoldCandidates.length} åªåŸºé‡‘...`);
                        const goldData = await fetch('/api/check_gold_rating', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ funds: allGoldCandidates })
                        }).then(res => res.json());
                        
                        if (goldData.success) {
                            let redStarCount = 0;
                            allFunds.forEach(fund => {
                                if (goldData.data[fund.ts_code]) {
                                    fund.isRedStar = true;
                                    redStarCount++;
                                }
                            });
                            console.log(`âœ“ å‘ç° ${redStarCount} åªçº¢æ˜Ÿè¯„çº§åŸºé‡‘`);
                        }
                    } catch (error) {
                        console.warn('æ£€æŸ¥çº¢æ˜Ÿè¯„çº§å¤±è´¥:', error);
                    }
                }
                
                // ğŸ”¥ æ’åºï¼šå…ˆæŒ‰æ˜Ÿçº§é™åºï¼Œå†æŒ‰çº¢æ˜Ÿè¯„çº§
                allFunds.sort((a, b) => {
                    // ç¬¬ä¸€æ’åºï¼šæ˜Ÿçº§ï¼ˆé™åºï¼‰
                    const starDiff = (b.starCount || 0) - (a.starCount || 0);
                    if (starDiff !== 0) return starDiff;
                    
                    // ç¬¬äºŒæ’åºï¼šçº¢æ˜Ÿè¯„çº§ï¼ˆé™åºï¼‰
                    const redA = a.isRedStar ? 1 : 0;
                    const redB = b.isRedStar ? 1 : 0;
                    return redB - redA;
                });
                
                // å¼ºåˆ¶åˆ·æ–°å½“å‰é¡µæ˜¾ç¤º
                displayPage(currentPage);
                
                btn.disabled = false;
                btn.textContent = USE_CACHE ? 'è®¡ç®—æ‰€æœ‰æ”¶ç›Š' : 'âš¡ é‡æ–°å®æ—¶è®¡ç®—';
                
                if (isManualClick) {
                    console.log(`âœ“ æ‰¹é‡è®¡ç®—å®Œæˆï¼è€—æ—¶: ${duration}ç§’ï¼Œå…± ${allFunds.length} åªåŸºé‡‘`);
                    if (statusSpan) {
                        statusSpan.innerHTML = `âœ… è®¡ç®—å®Œæˆï¼è€—æ—¶ ${duration}ç§’`;
                        statusSpan.style.color = '#16a34a';
                    }
                } else {
                    console.log(`âœ“ è‡ªåŠ¨åŠ è½½å®Œæˆï¼è€—æ—¶: ${duration}ç§’ï¼Œå…± ${allFunds.length} åªåŸºé‡‘`);
                    // ğŸ”¥ è‡ªåŠ¨åŠ è½½å®Œæˆåæ˜¾ç¤ºåˆ—è¡¨
                    showFundList();
                }
                console.log(`  æ•°æ®æ¥æº: ${USE_CACHE ? 'ğŸ“¦ ç¼“å­˜' : 'âš¡ å®æ—¶è®¡ç®—'}`);
                
            } catch (error) {
                console.error('æ‰¹é‡è®¡ç®—å¤±è´¥:', error);
                showNotification('è®¡ç®—å¤±è´¥: ' + error.message, 'é”™è¯¯');
                btn.disabled = false;
                btn.textContent = 'é‡æ–°è®¡ç®—';
                
                // å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤ºåˆ—è¡¨
                if (!isManualClick) {
                    showFundList();
                }
            }
        }

        // æ›´æ–°åŸºé‡‘è¡Œæ•°æ®
        function updateFundRow(fund) {
            const safeCode = fund.ts_code.replace(/\./g, '_');
            
            const cells = {
                'return2025': fund.return2025,
                'return2024': fund.return2024,
                'return2023': fund.return2023,
                'score': fund.score,
                'rating': fund.rating
            };

            for (const [key, value] of Object.entries(cells)) {
                const cell = document.getElementById(`${key}_${safeCode}`);
                if (cell) {
                    if (key === 'score') {
                        cell.innerHTML = formatScore(value);
                    } else if (key === 'rating') {
                        // ğŸ”¥ ä½¿ç”¨çº¢æ˜Ÿè¯„çº§æ ‡è®°
                        cell.innerHTML = formatRating(value, fund.isRedStar || false);
                    } else {
                        cell.innerHTML = formatReturn(value);
                    }
                    cell.className = '';
                }
            }
        }

        // è®¡ç®—å¹´åº¦æ”¶ç›Š
        async function calculateYearReturn(tsCode, year) {
            try {
                const response = await fetch(`/api/fund/${tsCode}/year_return?year=${year}`);
                const data = await response.json();
                return data.success && data.data ? data.data.return : null;
            } catch {
                return null;
            }
        }

        // è®¡ç®—æœŸé—´æ”¶ç›Š
        async function calculatePeriodReturn(tsCode, days) {
            try {
                const response = await fetch(`/api/fund/${tsCode}/period_return?days=${days}`);
                const data = await response.json();
                return data.success && data.data ? data.data.return : null;
            } catch {
                return null;
            }
        }

        // è®¡ç®—è¯„åˆ†
        async function calculateScore(tsCode) {
            try {
                const response = await fetch(`/api/fund/${tsCode}/score`);
                const data = await response.json();
                return data.success && data.data ? data.data.æ€»åˆ† : null;
            } catch {
                return null;
            }
        }

        // æ˜¾ç¤ºåŸºé‡‘è¯¦æƒ…
        async function showFundDetail(tsCode) {
            showLoading(true);
            hideFundList();

            try {
                const response = await fetch(`/api/fund/${encodeURIComponent(tsCode)}`);
                const data = await response.json();

                if (data.success) {
                    let report = data.data;
                    
                    console.log('åŸºé‡‘è¯¦æƒ…æ•°æ®:', report);
                    console.log('åŸå§‹è¯„åˆ†æ•°æ®:', report.ç»¼åˆè¯„åˆ†);
                    
                    // ğŸ”¥ å¦‚æœè¯„åˆ†ä¸ºç©ºã€æ— æ•ˆæˆ–ä¸º0åˆ†ï¼Œç«‹å³é‡æ–°è®¡ç®—è¯„åˆ†
                    const needRecalculate = !report.ç»¼åˆè¯„åˆ† || 
                                          report.ç»¼åˆè¯„åˆ†.æ€»åˆ† === 0 || 
                                          report.ç»¼åˆè¯„åˆ†.æ€»åˆ† === null || 
                                          report.ç»¼åˆè¯„åˆ†.æ€»åˆ† === undefined ||
                                          report.ç»¼åˆè¯„åˆ†.è¯„çº§ === 'æœªè¯„çº§';
                    
                    if (needRecalculate) {
                        console.log('âš ï¸ è¯„åˆ†æ— æ•ˆï¼Œç«‹å³é‡æ–°è®¡ç®—è¯„åˆ†...');
                        console.log('  - æ€»åˆ†:', report.ç»¼åˆè¯„åˆ†?.æ€»åˆ†);
                        console.log('  - è¯„çº§:', report.ç»¼åˆè¯„åˆ†?.è¯„çº§);
                        
                        try {
                            showNotification('æ­£åœ¨è®¡ç®—è¯„åˆ†ï¼Œè¯·ç¨å€™...', 'æç¤º');
                            const scoreResponse = await fetch(`/api/fund/${encodeURIComponent(tsCode)}/score`);
                            const scoreData = await scoreResponse.json();
                            
                            console.log('è¯„åˆ†APIå“åº”:', scoreData);
                            
                            if (scoreData.success && scoreData.data) {
                                report.ç»¼åˆè¯„åˆ† = scoreData.data;
                                console.log('âœ“ è¯„åˆ†è®¡ç®—å®Œæˆ:', report.ç»¼åˆè¯„åˆ†);
                            } else {
                                console.error('è¯„åˆ†APIè¿”å›å¤±è´¥:', scoreData);
                            }
                        } catch (scoreError) {
                            console.error('è¯„åˆ†è®¡ç®—å¤±è´¥:', scoreError);
                            // ä½¿ç”¨é»˜è®¤å€¼
                            report.ç»¼åˆè¯„åˆ† = {
                                æ€»åˆ†: 0,
                                æ”¶ç›Šå¾—åˆ†: 0,
                                é£é™©å¾—åˆ†: 0,
                                è¯„çº§: 'æœªè¯„çº§',
                                æ•°æ®å¹´é™: 0,
                                æ”¶ç›Šè¯¦æƒ…: {},
                                é£é™©è¯¦æƒ…: {}
                            };
                        }
                    } else {
                        console.log('âœ“ è¯„åˆ†æœ‰æ•ˆï¼Œç›´æ¥ä½¿ç”¨:', report.ç»¼åˆè¯„åˆ†.æ€»åˆ†);
                    }
                    
                    renderFundDetail(report);
                    showDetail();
                } else {
                    showNotification('è·å–åŸºé‡‘è¯¦æƒ…å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'é”™è¯¯');
                }
            } catch (error) {
                showNotification('è·å–å¤±è´¥ï¼š' + error.message, 'é”™è¯¯');
                console.error('è¯¦æƒ…é¡µé”™è¯¯:', error);
            } finally {
                showLoading(false);
            }
        }

        // æ¸²æŸ“åŸºé‡‘è¯¦æƒ…
        function renderFundDetail(report) {
            window.__currentFundReport = report;  // ç¼“å­˜å½“å‰åŸºé‡‘æŠ¥å‘Šï¼Œç”¨äºå›¾è¡¨ç­‰åç»­åˆ†æ
            // åŸºæœ¬ä¿¡æ¯ï¼ˆé¡¶éƒ¨ï¼‰
            document.getElementById('fundName').textContent = report.åŸºæœ¬ä¿¡æ¯.åŸºé‡‘åç§°;
            document.getElementById('detailFundCode').textContent = report.åŸºé‡‘ä»£ç ;
            document.getElementById('detailFundType').textContent = report.åŸºæœ¬ä¿¡æ¯.åŸºé‡‘ç±»å‹;
            document.getElementById('detailFundCompany').textContent = report.åŸºæœ¬ä¿¡æ¯.ç®¡ç†å…¬å¸;

            // åŸºæœ¬ä¿¡æ¯è¡¨æ ¼
            document.getElementById('infoCode').textContent = report.åŸºé‡‘ä»£ç ;
            document.getElementById('infoName').textContent = report.åŸºæœ¬ä¿¡æ¯.åŸºé‡‘åç§°;
            document.getElementById('infoType').textContent = report.åŸºæœ¬ä¿¡æ¯.åŸºé‡‘ç±»å‹ || '--';
            document.getElementById('infoCompany').textContent = report.åŸºæœ¬ä¿¡æ¯.ç®¡ç†å…¬å¸ || '--';
            document.getElementById('infoFoundDate').textContent = report.åŸºæœ¬ä¿¡æ¯.æˆç«‹æ—¥æœŸ || '--';
            document.getElementById('infoListDate').textContent = report.åŸºæœ¬ä¿¡æ¯.ä¸Šå¸‚æ—¥æœŸ || '--';
            document.getElementById('infoStatus').textContent = report.åŸºæœ¬ä¿¡æ¯.åŸºé‡‘çŠ¶æ€ === 'L' ? 'åœ¨å”®' : 'å·²åœå”®';
            document.getElementById('infoScale').textContent = report.æœ€æ–°è§„æ¨¡ || '--';

            // åŠ è½½æŒä»“è‚¡ç¥¨åˆ—è¡¨
            loadHoldings(report.åŸºé‡‘ä»£ç );
            
            // ç”ŸæˆæŠ•èµ„å»ºè®®
            generateInvestmentAdvice(report);
            
            // ç”Ÿæˆæ”¶ç›Šå¯¹æ¯”
            generateReturnComparison(report.åŸºé‡‘ä»£ç , report);

            // æŒä»“é›†ä¸­åº¦
            const holdingInfo = document.getElementById('holdingInfo');
            if (report.æŒä»“é›†ä¸­åº¦) {
                holdingInfo.innerHTML = `
                    <p style="font-size: 0.85rem; line-height: 1.8;">
                        <strong>å‰5å¤§æŒä»“å æ¯”ï¼š</strong>${report.æŒä»“é›†ä¸­åº¦.å‰5å¤§æŒä»“å æ¯”}%<br>
                        <strong>å‰10å¤§æŒä»“å æ¯”ï¼š</strong>${report.æŒä»“é›†ä¸­åº¦.å‰10å¤§æŒä»“å æ¯”}%<br>
                        <strong>é›†ä¸­åº¦è¯„çº§ï¼š</strong>${report.æŒä»“é›†ä¸­åº¦.é›†ä¸­åº¦è¯„çº§}
                    </p>
                `;
            } else {
                holdingInfo.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.85rem;">æš‚æ— æŒä»“æ•°æ®</p>';
            }

            // åˆ†æéƒ¨åˆ†
            // é£é™©æŒ‡æ ‡ - ä½¿ç”¨è¡¨æ ¼
            const riskGrid = document.getElementById('riskGrid');
            let riskHtml = '';
            let riskCount = 0;
            let riskRowHtml = '<tr>';
            
            for (const [metric, value] of Object.entries(report.é£é™©åˆ†æ)) {
                if (value !== null && value !== undefined) {
                    const displayValue = (metric === 'æœ€å¤§å›æ’¤' || metric === 'æ³¢åŠ¨ç‡') ? `${value}%` : value;
                    riskRowHtml += `<th>${metric}ï¼š</th><td style="font-weight: 600;">${displayValue}</td>`;
                    riskCount++;
                    
                    if (riskCount === 3) {
                        riskRowHtml += '</tr>';
                        riskHtml += riskRowHtml;
                        riskRowHtml = '<tr>';
                        riskCount = 0;
                    }
                }
            }
            
            if (riskCount > 0) {
                while (riskCount < 3) {
                    riskRowHtml += '<th></th><td></td>';
                    riskCount++;
                }
                riskRowHtml += '</tr>';
                riskHtml += riskRowHtml;
            }
            
            riskGrid.innerHTML = riskHtml || '<tr><td style="color: var(--text-secondary); text-align: center;">æš‚æ— æ•°æ®</td></tr>';

            // ç»¼åˆè¯„åˆ† - ä½¿ç”¨è¡¨æ ¼ï¼ˆæ–°ç‰ˆv2.0ï¼‰
            const scoreGrid = document.getElementById('scoreGrid');
            const score = report.ç»¼åˆè¯„åˆ†;
            
            let scoreHtml = `
                <tr>
                    <th>ç»¼åˆè¯„åˆ†ï¼š</th>
                    <td style="font-weight: 600; font-size: 1.1rem;">${score.æ€»åˆ†}/100 <span style="color: var(--primary-color);">${score.è¯„çº§}</span></td>
                    <th>æ•°æ®å¹´é™ï¼š</th>
                    <td style="font-weight: 600;">${score.æ•°æ®å¹´é™ || '--'}å¹´</td>
                </tr>
                <tr>
                    <th>æ”¶ç›Šå¾—åˆ†ï¼š</th>
                    <td style="font-weight: 600; color: ${score.æ”¶ç›Šå¾—åˆ† > 60 ? '#dc2626' : '#666'};">${score.æ”¶ç›Šå¾—åˆ†}/80</td>
                    <th>é£é™©å¾—åˆ†ï¼š</th>
                    <td style="font-weight: 600; color: ${score.é£é™©å¾—åˆ† > 15 ? '#dc2626' : '#666'};">${score.é£é™©å¾—åˆ†}/20</td>
                </tr>
            `;
            
            // æ˜¾ç¤ºæ”¶ç›Šè¯¦æƒ…
            if (score.æ”¶ç›Šè¯¦æƒ… && score.æ”¶ç›Šè¯¦æƒ….ç´¯è®¡æ”¶ç›Š !== undefined) {
                scoreHtml += `
                <tr>
                    <th>5å¹´ç´¯è®¡æ”¶ç›Šï¼š</th>
                    <td colspan="3" style="font-weight: 600; color: ${score.æ”¶ç›Šè¯¦æƒ….ç´¯è®¡æ”¶ç›Š > 0 ? '#dc2626' : '#16a34a'};">
                        ${score.æ”¶ç›Šè¯¦æƒ….ç´¯è®¡æ”¶ç›Š > 0 ? '+' : ''}${score.æ”¶ç›Šè¯¦æƒ….ç´¯è®¡æ”¶ç›Š}%
                    </td>
                </tr>
                `;
            }
            
            // æ˜¾ç¤ºé£é™©è¯¦æƒ…ï¼ˆå›æ’¤ç”¨ç»¿è‰²è¡¨ç¤ºï¼‰
            if (score.é£é™©è¯¦æƒ… && score.é£é™©è¯¦æƒ….ç´¯è®¡å›æ’¤ !== undefined) {
                scoreHtml += `
                <tr>
                    <th>5å¹´ç´¯è®¡å›æ’¤ï¼š</th>
                    <td colspan="3" style="font-weight: 600; color: #16a34a;">
                        -${score.é£é™©è¯¦æƒ….ç´¯è®¡å›æ’¤}%
                    </td>
                </tr>
                `;
            }
            
            scoreGrid.innerHTML = scoreHtml;
        }

        // åŠ è½½æŒä»“è‚¡ç¥¨åˆ—è¡¨
        async function loadHoldings(tsCode) {
            try {
                const response = await fetch(`/api/fund/${encodeURIComponent(tsCode)}/holdings`);
                const data = await response.json();

                const holdingsTable = document.getElementById('holdingsTable');

                if (!data.success) {
                    console.error('APIè¿”å›é”™è¯¯:', data.error);
                    holdingsTable.innerHTML = `<p style="color: var(--danger-color); font-size: 0.85rem;">åŠ è½½å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    return;
                }

                if (data.data && data.data.length > 0) {
                    let tableHTML = `
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead>
                                <tr style="background: var(--bg-color); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 0.6rem; text-align: left;">æ’å</th>
                                    <th style="padding: 0.6rem; text-align: left;">è‚¡ç¥¨ä»£ç </th>
                                    <th style="padding: 0.6rem; text-align: left;">è‚¡ç¥¨åç§°</th>
                                    <th style="padding: 0.6rem; text-align: right;">æŒä»“å¸‚å€¼(ä¸‡)</th>
                                    <th style="padding: 0.6rem; text-align: right;">å å‡€å€¼æ¯”(%)</th>
                                    <th style="padding: 0.6rem; text-align: right;">å æµé€šè‚¡æ¯”(%)</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.data.forEach((holding, index) => {
                        tableHTML += `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.6rem;">${index + 1}</td>
                                <td style="padding: 0.6rem; font-weight: 600; color: var(--primary-color);">${holding.symbol || '--'}</td>
                                <td style="padding: 0.6rem; font-weight: 500;">${holding.stock_name || '--'}</td>
                                <td style="padding: 0.6rem; text-align: right;">${holding.mkv ? (holding.mkv / 10000).toFixed(2) : '--'}</td>
                                <td style="padding: 0.6rem; text-align: right; font-weight: 600;">${holding.stk_mkv_ratio ? holding.stk_mkv_ratio.toFixed(2) : '--'}</td>
                                <td style="padding: 0.6rem; text-align: right;">${holding.stk_float_ratio ? holding.stk_float_ratio.toFixed(2) : '--'}</td>
                            </tr>
                        `;
                    });

                    tableHTML += `
                            </tbody>
                        </table>
                        <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                            æ•°æ®æ—¥æœŸï¼š${data.data[0]?.end_date || '--'}
                        </p>
                    `;

                    holdingsTable.innerHTML = tableHTML;
                } else {
                    holdingsTable.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.85rem;">æš‚æ— æŒä»“æ•°æ®</p>';
                }
            } catch (error) {
                console.error('åŠ è½½æŒä»“æ•°æ®å¤±è´¥:', error);
                document.getElementById('holdingsTable').innerHTML = `<p style="color: var(--danger-color);">ç½‘ç»œé”™è¯¯æˆ–æ•°æ®æ ¼å¼å¼‚å¸¸: ${error.message}</p>`;
            }
        }

        function createDataCard(label, value, type = 'default') {
            const card = document.createElement('div');
            card.className = `data-card ${type}`;
            card.innerHTML = `
                <div class="data-label">${label}</div>
                <div class="data-value">${value}</div>
            `;
            return card;
        }

        // ç”ŸæˆæŠ•èµ„å»ºè®®
        function generateInvestmentAdvice(report) {
            const adviceDiv = document.getElementById('investmentAdvice');
            const score = report.ç»¼åˆè¯„åˆ†.æ€»åˆ†;
            const risk = report.é£é™©åˆ†æ;
            
            let adviceHTML = '<div style="font-size: 0.9rem; line-height: 1.8;">';
            
            // æ ¹æ®è¯„åˆ†ç»™å‡ºå»ºè®®ï¼ˆçº¢æ¶¨ç»¿è·Œï¼šå¥½=çº¢è‰²ï¼Œå·®=ç»¿è‰²ï¼‰
            if (score >= 80) {
                adviceHTML += '<p style="font-size: 1rem; font-weight: 700; color: #dc2626; margin-bottom: 1rem;">â­ ä¼˜è´¨åŸºé‡‘ - æ¨èå…³æ³¨</p>';
                adviceHTML += '<p>âœ… <strong>ä¼˜åŠ¿ï¼š</strong>è¯¥åŸºé‡‘ç»¼åˆè¡¨ç°ä¼˜ç§€ï¼Œåœ¨æ”¶ç›Šã€é£é™©æ§åˆ¶ç­‰å¤šä¸ªç»´åº¦è¡¨ç°çªå‡ºã€‚</p>';
                adviceHTML += '<p>ğŸ’¡ <strong>å»ºè®®ï¼š</strong>é€‚åˆä¸­é•¿æœŸæŠ•èµ„ï¼Œå¯ä½œä¸ºæ ¸å¿ƒé…ç½®ã€‚å»ºè®®å®šæŠ•æˆ–é€¢ä½å¸ƒå±€ã€‚</p>';
            } else if (score >= 70) {
                adviceHTML += '<p style="font-size: 1rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1rem;">â­ è‰¯å¥½åŸºé‡‘ - å€¼å¾—è€ƒè™‘</p>';
                adviceHTML += '<p>âœ… <strong>ä¼˜åŠ¿ï¼š</strong>è¯¥åŸºé‡‘æ•´ä½“è¡¨ç°è‰¯å¥½ï¼Œå…·å¤‡ä¸€å®šæŠ•èµ„ä»·å€¼ã€‚</p>';
                adviceHTML += '<p>ğŸ’¡ <strong>å»ºè®®ï¼š</strong>é€‚åˆä¸­æœŸæŠ•èµ„ï¼Œå»ºè®®ç»“åˆè‡ªèº«é£é™©æ‰¿å—èƒ½åŠ›é…ç½®é€‚å½“æ¯”ä¾‹ã€‚</p>';
            } else if (score >= 60) {
                adviceHTML += '<p style="font-size: 1rem; font-weight: 700; color: var(--warning-color); margin-bottom: 1rem;">â­ ä¸­ç­‰åŸºé‡‘</p>';
                adviceHTML += '<p>âš ï¸ <strong>æç¤ºï¼š</strong>è¯¥åŸºé‡‘è¡¨ç°ä¸€èˆ¬ï¼Œéƒ¨åˆ†æŒ‡æ ‡æœ‰å¾…æå‡ã€‚</p>';
                adviceHTML += '<p>ğŸ’¡ <strong>å»ºè®®ï¼š</strong>å»ºè®®æŒç»­è§‚å¯Ÿï¼ŒçŸ­æœŸé…ç½®ä¸ºä¸»ï¼Œä¸å®œé‡ä»“ã€‚</p>';
            } else {
                adviceHTML += '<p style="font-size: 1rem; font-weight: 700; color: #16a34a; margin-bottom: 1rem;">â­ å¼±åŠ¿åŸºé‡‘</p>';
                adviceHTML += '<p>âš ï¸ <strong>é£é™©ï¼š</strong>è¯¥åŸºé‡‘ç»¼åˆè¡¨ç°è¾ƒå¼±</p>';
                adviceHTML += '<p>ğŸ’¡ <strong>å»ºè®®ï¼š</strong>æ— å»ºè®®ã€‚</p>';
            }
            
            // é£é™©æç¤ºï¼ˆçº¢è‰²=é£é™©é«˜ï¼‰
            if (risk.æœ€å¤§å›æ’¤ && risk.æœ€å¤§å›æ’¤ < -30) {
                adviceHTML += '<p style="color: #dc2626; margin-top: 1rem;">âš ï¸ <strong>é£é™©è­¦ç¤ºï¼š</strong>è¯¥åŸºé‡‘å†å²æœ€å¤§å›æ’¤è¶…è¿‡30%ï¼Œæ³¢åŠ¨è¾ƒå¤§ï¼Œè¯·æ³¨æ„é£é™©æ§åˆ¶ï¼</p>';
            }
            
            adviceHTML += '</div>';
            adviceDiv.innerHTML = adviceHTML;
        }

        // å…¨å±€å›¾è¡¨å¯¹è±¡
        let returnsChartInstance = null;
        let navChartInstance = null;
        
        // ğŸ¨ ç»˜åˆ¶æ”¶ç›Šç‡å’Œå‡€å€¼å›¾è¡¨
        function drawChartsForReturns(yearReturns, yearEndNav, fromCache, hs300Data = null, fundEstDate = null) {
            // æ”¶ç›Šå›¾ï¼šæ ¹æ®åŸºé‡‘æˆç«‹æ—¥æœŸç¡®å®šèµ·å§‹å¹´ä»½
            let returnsYears = Object.keys(yearReturns).filter(year => yearReturns[year] !== null);
            
            // ğŸ”¥ å¦‚æœæä¾›äº†åŸºé‡‘æˆç«‹æ—¥æœŸï¼Œä»æˆç«‹å¹´ä»½çš„ä¸‹ä¸€å¹´å¼€å§‹
            if (fundEstDate) {
                const estYear = parseInt(fundEstDate.substring(0, 4));
                const startYear = estYear + 1;  // æˆç«‹å¹´ä»½çš„ä¸‹ä¸€å¹´æ‰æœ‰å®Œæ•´å¹´åº¦æ”¶ç›Š
                const currentYear = new Date().getFullYear();
                
                // ç”Ÿæˆä»æˆç«‹å¹´ä»½+1åˆ°å½“å‰å¹´ä»½çš„æ‰€æœ‰å¹´ä»½
                returnsYears = [];
                for (let year = startYear; year <= currentYear; year++) {
                    returnsYears.push(year.toString());
                }
            } else if (fromCache && USE_CACHE) {
                // å¦‚æœæ²¡æœ‰æˆç«‹æ—¥æœŸï¼Œä½¿ç”¨ç¼“å­˜ä¸­çš„æ‰€æœ‰å¹´ä»½
                returnsYears = AVAILABLE_YEARS.filter(year => year in yearReturns);
            }
            
            // æŒ‰å¹´ä»½æ’åºï¼ˆå‡åºï¼Œç”¨äºå›¾è¡¨æ˜¾ç¤ºï¼‰
            returnsYears.sort();
            
            const returnsValues = returnsYears.map(year => yearReturns[year] || 0);
            
            // å‡€å€¼å›¾ï¼šä½¿ç”¨12æœˆæ•°æ®ï¼Œæ‰€æœ‰å¯ç”¨å¹´ä»½
            const navYears = Object.keys(yearEndNav).sort();
            const navValues = navYears.map(year => yearEndNav[year]);
            
            // ç»˜åˆ¶æ”¶ç›Šç‡å›¾è¡¨
            const returnsCtx = document.getElementById('returnsChart');
            if (returnsCtx) {
                // é”€æ¯æ—§å›¾è¡¨
                if (returnsChartInstance) {
                    returnsChartInstance.destroy();
                }
                
                returnsChartInstance = new Chart(returnsCtx, {
                    type: 'bar',
                    data: {
                        labels: returnsYears.map(y => y + 'å¹´'),
                        datasets: [{
                            label: 'å¹´åº¦æ”¶ç›Šç‡ (%)',
                            data: returnsValues,
                            backgroundColor: returnsValues.map(v => 
                                v > 0 ? 'rgba(220, 38, 38, 0.7)' :    // çº¢è‰²ï¼ˆæ¶¨ï¼‰
                                v < 0 ? 'rgba(22, 163, 74, 0.7)' :     // ç»¿è‰²ï¼ˆè·Œï¼‰
                                'rgba(100, 116, 139, 0.7)'              // ç°è‰²ï¼ˆæŒå¹³ï¼‰
                            ),
                            borderColor: returnsValues.map(v => 
                                v > 0 ? 'rgba(220, 38, 38, 1)' : 
                                v < 0 ? 'rgba(22, 163, 74, 1)' : 
                                'rgba(100, 116, 139, 1)'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        return value > 0 ? `+${value}%` : `${value}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            // ç»˜åˆ¶å‡€å€¼å›¾è¡¨ï¼ˆå«æ²ªæ·±300å¯¹ç…§ï¼‰
            const navCtx = document.getElementById('navChart');
            if (navCtx) {
                // é”€æ¯æ—§å›¾è¡¨
                if (navChartInstance) {
                    navChartInstance.destroy();
                }
                
                // å‡†å¤‡æ•°æ®é›†
                const datasets = [{
                    label: 'åŸºé‡‘å‡€å€¼',
                    data: navValues,
                    borderColor: 'rgba(37, 99, 235, 1)',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(37, 99, 235, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y'
                }];
                
                // å¦‚æœæœ‰æ²ªæ·±300æ•°æ®ï¼Œæ·»åŠ å¯¹ç…§æ›²çº¿
                let hs300Values = [];
                if (hs300Data && Object.keys(hs300Data).length > 0) {
                    // åŒ¹é…å¹´ä»½ï¼Œä»æ²ªæ·±300æ•°æ®ä¸­æå–å¯¹åº”å¹´ä»½çš„æœ€æ–°å€¼
                    hs300Values = navYears.map(year => {
                        // ğŸ”¥ å…ˆå°è¯•12æœˆæ•°æ®ï¼ˆå¹´æœ«ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‰¾è¯¥å¹´çš„æœ€æ–°æ—¥æœŸ
                        // 1. å°è¯•12æœˆï¼ˆ12-31, 12-30, ..., 12-01ï¼‰
                        for (let day = 31; day >= 1; day--) {
                            const dateStr = `${year}-12-${String(day).padStart(2, '0')}`;
                            if (hs300Data[dateStr] !== undefined) {
                                return hs300Data[dateStr];
                            }
                        }
                        
                        // 2. å¦‚æœ12æœˆæ²¡æ•°æ®ï¼ˆå¦‚2025å¹´è¿˜æ²¡åˆ°12æœˆï¼‰ï¼Œæ‰¾è¯¥å¹´çš„æœ€æ–°æ—¥æœŸ
                        const yearDates = Object.keys(hs300Data)
                            .filter(date => date.startsWith(year + '-'))
                            .sort()
                            .reverse();
                        
                        if (yearDates.length > 0) {
                            console.log(`${year}å¹´æœªåˆ°12æœˆï¼Œä½¿ç”¨æœ€æ–°æ—¥æœŸ: ${yearDates[0]}`);
                            return hs300Data[yearDates[0]];
                        }
                        
                        return null;
                    });
                    
                    // å½’ä¸€åŒ–ï¼šè®©ä¸¤ä¸ªYè½´åœ¨ç›¸åŒé«˜åº¦æ˜¾ç¤ºç›¸åŒçš„æ¶¨å¹…ç™¾åˆ†æ¯”
                    // è®¡ç®—åŸºå‡†å€¼ï¼ˆç¬¬ä¸€ä¸ªæœ‰æ•ˆå€¼ï¼‰
                    const fundBase = navValues.find(v => v !== null) || 1;
                    const hs300Base = hs300Values.find(v => v !== null) || 1;
                    
                    // è½¬æ¢ä¸ºç™¾åˆ†æ¯”æ¶¨å¹…ï¼ˆç›¸å¯¹äºåŸºå‡†å€¼ï¼‰
                    const fundPercents = navValues.map(v => v !== null ? ((v - fundBase) / fundBase * 100) : null);
                    const hs300Percents = hs300Values.map(v => v !== null ? ((v - hs300Base) / hs300Base * 100) : null);
                    
                    // æ›¿æ¢datasetsï¼Œä½¿ç”¨ç™¾åˆ†æ¯”æ•°æ®
                    datasets[0].data = fundPercents;
                    datasets[0].label = 'åŸºé‡‘æ¶¨å¹… (%)';
                    
                    datasets.push({
                        label: 'æ²ªæ·±300æ¶¨å¹… (%)',
                        data: hs300Percents,
                        borderColor: 'rgba(220, 38, 38, 0.8)',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: 'rgba(220, 38, 38, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        yAxisID: 'y'  // ä½¿ç”¨åŒä¸€ä¸ªYè½´
                    });
                }
                
                navChartInstance = new Chart(navCtx, {
                    type: 'line',
                    data: {
                        labels: navYears.map(y => y + 'å¹´'),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: hs300Values.length > 0,  // æœ‰å¯¹ç…§æ•°æ®æ—¶æ˜¾ç¤ºå›¾ä¾‹
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    padding: 10,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        if (hs300Values.length > 0) {
                                            // æ˜¾ç¤ºç™¾åˆ†æ¯”
                                            return `${label}: ${value > 0 ? '+' : ''}${value.toFixed(2)}%`;
                                        } else {
                                            // æ˜¾ç¤ºå‡€å€¼
                                            return `${label}: ${value.toFixed(4)}`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                position: 'left',
                                title: {
                                    display: hs300Values.length > 0,
                                    text: 'æ¶¨å¹… (%)',
                                    font: {
                                        size: 11
                                    }
                                },
                                ticks: {
                                    callback: function(value) {
                                        if (hs300Values.length > 0) {
                                            return value.toFixed(1) + '%';
                                        } else {
                                            return value.toFixed(2);
                                        }
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }

        // ç”Ÿæˆæ”¶ç›Šå¯¹æ¯”
        async function generateReturnComparison(tsCode, fundReport) {
            const effectiveReport = fundReport || window.__currentFundReport;
            if (!effectiveReport) {
                console.warn('generateReturnComparison: æ— æœ‰æ•ˆåŸºé‡‘æŠ¥å‘Šæ•°æ®ï¼Œå·²è·³è¿‡ç»˜åˆ¶ã€‚', tsCode);
                return;
            }
            window.__currentFundReport = effectiveReport;
            const comparisonDiv = document.getElementById('returnComparison');
            
            try {
                // ğŸ”¥ å¹¶è¡Œè·å–æ”¶ç›Šæ•°æ®ã€å‡€å€¼æ•°æ®å’Œæ²ªæ·±300æ•°æ®
                const [returnsResponse, navResponse, hs300Response] = await Promise.all([
                    fetch('/api/batch_year_returns', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ts_codes: [tsCode],
                            years: AVAILABLE_YEARS,  // ä½¿ç”¨æ‰€æœ‰å¯ç”¨å¹´ä»½
                            use_cache: USE_CACHE     // ä½¿ç”¨å…¨å±€å˜é‡
                        })
                    }),
                    fetch(`/api/fund/${tsCode}/year_end_nav`),
                    fetch('/api/index/000300/data')
                ]);
                
                const returnsData = await returnsResponse.json();
                const navData = await navResponse.json();
                const hs300DataResponse = await hs300Response.json();
                
                // ğŸ”¥ åŠ¨æ€è·å–æ‰€æœ‰å¹´ä»½çš„æ”¶ç›Šæ•°æ®
                let yearReturns = {};
                if (returnsData.success && returnsData.data[tsCode]) {
                    yearReturns = returnsData.data[tsCode];
                }
                
                // è·å–å‡€å€¼æ•°æ®
                let yearEndNav = {};
                if (navData.success && navData.data) {
                    yearEndNav = navData.data;
                }
                
                // è·å–æ²ªæ·±300æ•°æ®
                let hs300Data = {};
                if (hs300DataResponse.success && hs300DataResponse.data) {
                    hs300Data = hs300DataResponse.data;
                    console.log('âœ“ æ²ªæ·±300æ•°æ®è·å–æˆåŠŸ:', Object.keys(hs300Data).length, 'å¤©');
                } else {
                    console.log('âš ï¸ æ²ªæ·±300æ•°æ®è·å–å¤±è´¥:', hs300DataResponse.error);
                }
                
                // ğŸ¨ ç»˜åˆ¶å›¾è¡¨ï¼ˆå«æ²ªæ·±300å¯¹ç…§ï¼‰
                // è·å–åŸºé‡‘æˆç«‹æ—¥æœŸ
                const fundEstDate = effectiveReport?.åŸºæœ¬ä¿¡æ¯?.æˆç«‹æ—¥æœŸ || null;
                drawChartsForReturns(yearReturns, yearEndNav, returnsData.from_cache, hs300Data, fundEstDate);
                
                let html = '<div style="font-size: 0.85rem;">';
                html += '<p style="font-weight: 600; margin-bottom: 0.8rem; color: var(--text-primary);">ğŸ“ˆ å†å¹´æ”¶ç›Šèµ°åŠ¿åˆ†æ</p>';
                
                // ğŸ”¥ ä» yearReturns å¯¹è±¡æ„å»ºå¹´ä»½æ•°ç»„
                const sortedYears = Object.keys(yearReturns).sort((a, b) => b - a);  // é™åº
                const returns = sortedYears.map(year => yearReturns[year]).filter(r => r !== null);
                
                // åˆ†æè¶‹åŠ¿
                if (returns.length >= 2) {
                    let trend = '';
                    if (returns[0] > returns[1]) {  // æœ€æ–°å¹´ä»½ vs ä¸Šä¸€å¹´
                        trend = '<span style="color: #dc2626;">ğŸ“ˆ ä¸Šå‡è¶‹åŠ¿</span> - æ”¶ç›Šç‡å‘ˆç°æ”¹å–„';
                    } else {
                        trend = '<span style="color: #16a34a;">ğŸ“‰ ä¸‹é™è¶‹åŠ¿</span> - æ”¶ç›Šç‡æœ‰æ‰€å›è½';
                    }
                    html += `<p style="margin-bottom: 0.5rem;"><strong>è¶‹åŠ¿ï¼š</strong>${trend}</p>`;
                }
                
                // æ”¶ç›Šç¨³å®šæ€§
                if (returns.length >= 3) {
                    const allPositive = returns.every(r => r > 0);
                    const allNegative = returns.every(r => r < 0);
                    
                    if (allPositive) {
                        html += '<p style="margin-bottom: 0.5rem;"><strong>ç¨³å®šæ€§ï¼š</strong><span style="color: #dc2626;">âœ… ä¼˜ç§€</span> - è¿ç»­ç›ˆåˆ©</p>';
                    } else if (allNegative) {
                        html += '<p style="margin-bottom: 0.5rem;"><strong>ç¨³å®šæ€§ï¼š</strong><span style="color: #16a34a;">âš ï¸ è¾ƒå·®</span> - æŒç»­äºæŸ</p>';
                    } else {
                        html += '<p style="margin-bottom: 0.5rem;"><strong>ç¨³å®šæ€§ï¼š</strong><span style="color: var(--warning-color);">âš¡ æ³¢åŠ¨</span> - æ”¶ç›Šæ³¢åŠ¨è¾ƒå¤§</p>';
                    }
                }
                
                // ğŸ”¥ æ˜¾ç¤ºæ•°æ®æ¥æº
                if (returnsData.from_cache !== undefined) {
                    const sourceText = returnsData.from_cache ? 'ğŸ“¦ ç¼“å­˜æ•°æ®' : 'âš¡ å®æ—¶è®¡ç®—';
                    html += `<p style="margin-bottom: 0.5rem; color: var(--text-secondary);"><strong>æ•°æ®æ¥æºï¼š</strong>${sourceText}</p>`;
                }
                
                // å¹´åº¦å¯¹æ¯”è¡¨æ ¼
                html += '<table style="width: 100%; margin-top: 1rem; border-collapse: collapse;">';
                html += '<tr style="background: var(--bg-color); font-weight: 600;">';
                html += '<td style="padding: 0.5rem; border: 1px solid var(--border-color);">å¹´ä»½</td>';
                html += '<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: right;">æ”¶ç›Šç‡</td>';
                html += '<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center;">è¡¨ç°</td>';
                html += '</tr>';
                
                // ğŸ”¥ åŠ¨æ€æ„å»ºå¹´ä»½æ•°æ®ï¼ˆæ”¯æŒæ‰€æœ‰å¹´ä»½ï¼‰
                const yearData = sortedYears.map(year => ({
                    year: `${year}å¹´`,
                    return: yearReturns[year]
                }));
                
                yearData.forEach(item => {
                    if (item.return !== null) {
                        // ä¿®å¤ï¼š0% åº”è¯¥æ˜¾ç¤ºç°è‰²ï¼ˆä¸­æ€§ï¼‰ï¼Œä¸æ˜¯ç»¿è‰²
                        let color, displayText;
                        if (item.return > 0) {
                            color = '#dc2626';  // çº¢è‰²
                            displayText = `+${item.return}%`;
                        } else if (item.return < 0) {
                            color = '#16a34a';  // ç»¿è‰²
                            displayText = `${item.return}%`;
                        } else {
                            color = '#64748b';  // ç°è‰²ï¼ˆä¸­æ€§ï¼‰
                            displayText = '0%';
                        }
                        
                        const performance = item.return > 10 ? 'ğŸ”¥ ä¼˜ç§€' : item.return > 0 ? 'âœ… ç›ˆåˆ©' : item.return === 0 ? 'â– æŒå¹³' : item.return > -10 ? 'âš ï¸ å°å¹…äºæŸ' : 'âŒ è¾ƒå¤§äºæŸ';
                        html += `<tr style="border-bottom: 1px solid var(--border-color);">`;
                        html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color);">${item.year}</td>`;
                        html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: right; font-weight: 600; color: ${color};">${displayText}</td>`;
                        html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center;">${performance}</td>`;
                        html += `</tr>`;
                    }
                });
                
                html += '</table>';
                html += '</div>';
                
                comparisonDiv.innerHTML = html;
            } catch (error) {
                console.error('ç”Ÿæˆæ”¶ç›Šå¯¹æ¯”å¤±è´¥:', error);
                comparisonDiv.innerHTML = '<p style="color: var(--danger-color);">åŠ è½½å¤±è´¥</p>';
            }
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('fundSearch').value = '';
            document.getElementById('fundCompany').value = '';
            document.getElementById('fundType').value = '';
            document.getElementById('investType').value = '';
            document.getElementById('riskLevel').value = '';
            document.getElementById('fundStatus').value = 'L';
        }

        // UI æ§åˆ¶
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        function showFundList() {
            document.getElementById('fundListSection').classList.add('show');
        }

        function hideFundList() {
            document.getElementById('fundListSection').classList.remove('show');
        }

        function showDetail() {
            document.getElementById('detailSection').classList.add('show');
            showFloatBackBtn();
        }

        function hideDetail() {
            document.getElementById('detailSection').classList.remove('show');
            showFundList();
            hideFloatBackBtn();
        }
        
        // æµ®åŠ¨è¿”å›æŒ‰é’®æ§åˆ¶
        function showFloatBackBtn() {
            document.getElementById('floatBackBtn').classList.add('show');
        }
        
        function hideFloatBackBtn() {
            document.getElementById('floatBackBtn').classList.remove('show');
        }
        
        function backToHome() {
            hideDetail();
        }
    </script>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="footer-content">
            <!-- é£é™©æç¤º -->
            <div class="footer-warning">
                <h4>âš ï¸ æŠ•èµ„é£é™©æç¤º</h4>
                <p>
                    æœ¬ç³»ç»Ÿæä¾›çš„æ‰€æœ‰æ•°æ®å’Œåˆ†æä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚åŸºé‡‘æŠ•èµ„æœ‰é£é™©ï¼Œè¿‡å¾€ä¸šç»©ä¸ä»£è¡¨æœªæ¥è¡¨ç°ã€‚
                    æŠ•èµ„è€…åº”å……åˆ†äº†è§£åŸºé‡‘çš„æŠ•èµ„é£é™©ï¼Œæ ¹æ®è‡ªèº«é£é™©æ‰¿å—èƒ½åŠ›è°¨æ…å†³ç­–ï¼Œå¹¶è‡ªè¡Œæ‰¿æ‹…æŠ•èµ„é£é™©ã€‚
                    è¯·åœ¨æŠ•èµ„å‰ä»”ç»†é˜…è¯»åŸºé‡‘åˆåŒã€æ‹›å‹Ÿè¯´æ˜ä¹¦ç­‰æ³•å¾‹æ–‡ä»¶ã€‚
                </p>
            </div>

            <!-- é“¾æ¥ -->
            <div class="footer-links">
                <a href="https://github.com/hengruiyun/AI-Fund-Master" target="_blank">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    GitHub å¼€æºé¡¹ç›®
                </a>
            </div>

            <!-- ç‰ˆæƒä¿¡æ¯ -->
            <div class="footer-copyright">
                <p>Â© 2025 AIåŸºé‡‘å¤§å¸ˆ | ä½œè€…ï¼š267278466@qq.com</p>
            </div>
        </div>
    </footer>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥æ›´æ–°
        (function checkForUpdates() {
            // å»¶è¿Ÿ 2 ç§’åæ£€æŸ¥æ›´æ–°ï¼Œé¿å…å½±å“é¡µé¢åŠ è½½
            setTimeout(async () => {
                try {
                    const response = await fetch('/api/check_update');
                    const result = await response.json();
                    
                    if (result.success && result.has_update) {
                        const data = result.data;
                        
                        // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
                        const message = `å‘ç°æ–°ç‰ˆæœ¬ v${data.latest_version}ï¼\n\n` +
                                      `å½“å‰ç‰ˆæœ¬ï¼šv${data.current_version}\n` +
                                      `æœ€æ–°ç‰ˆæœ¬ï¼šv${data.latest_version}\n\n` +
                                      `æ˜¯å¦å‰å¾€ä¸‹è½½é¡µé¢ï¼Ÿ`;
                        
                        if (confirm(message)) {
                            window.open(data.download_url, '_blank');
                        }
                        
                        console.log('âœ“ å‘ç°æ–°ç‰ˆæœ¬:', data);
                    } else {
                        console.log('âœ“ å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
                    }
                } catch (error) {
                    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½¿ç”¨
                    console.log('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error.message);
                }
            }, 2000);
        })();

        // ğŸ”¥ å¿ƒè·³ä¿æ´»æœºåˆ¶ï¼šæ¯10åˆ†é’Ÿå‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œé˜²æ­¢20åˆ†é’Ÿç©ºé—²è‡ªåŠ¨é€€å‡º
        (function startHeartbeat() {
            const HEARTBEAT_INTERVAL = 10 * 60 * 1000;  // 10åˆ†é’Ÿ
            
            async function sendHeartbeat() {
                try {
                    const response = await fetch('/api/version', {
                        method: 'GET',
                        headers: { 'X-Heartbeat': 'true' }
                    });
                    
                    if (response.ok) {
                        const now = new Date().toLocaleTimeString();
                        console.log(`ğŸ’“ [${now}] å¿ƒè·³ä¿æ´»æˆåŠŸ - å·²é‡ç½®ç©ºé—²è®¡æ—¶å™¨`);
                    }
                } catch (error) {
                    console.warn('ğŸ’” å¿ƒè·³ä¿æ´»å¤±è´¥:', error.message);
                }
            }
            
            // ç«‹å³å‘é€ä¸€æ¬¡å¿ƒè·³ï¼ˆå»¶è¿Ÿ5ç§’ï¼Œé¿å…ä¸åˆå§‹åŒ–å†²çªï¼‰
            setTimeout(sendHeartbeat, 5000);
            
            // æ¯10åˆ†é’Ÿå‘é€ä¸€æ¬¡
            setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);
            
            console.log('âœ“ å¿ƒè·³ä¿æ´»å·²å¯åŠ¨ï¼ˆé—´éš”ï¼š10åˆ†é’Ÿï¼‰');
        })();
    </script>
</body>
</html>
